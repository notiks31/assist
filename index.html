<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* -------------------------------------------
       [1] 설정 및 초기화
       ------------------------------------------- */
    const mapContainer = document.getElementById('map');
    const mapOption = { 
        center: new kakao.maps.LatLng(37.566826, 126.9786567), // 초기 서울 중심
        level: 6 
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places(); 
    
    // ★ TMAP API 키 (데이터용) ★
    const TMAP_APP_KEY = 'vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti'; 

    let polylines = [];
    let markers = [];
    let isTrafficOn = false;

    // 로딩 시 내 위치로 이동
    window.onload = () => moveToCurrentLocation();

    /* -------------------------------------------
       [2] UI 인터랙션
       ------------------------------------------- */
    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                // 내 위치 마커
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
                const overlay = new kakao.maps.CustomOverlay({ map: map, position: loc, content: content });
                markers.push(overlay);
                map.panTo(loc);
            });
        }
    }

    function toggleTraffic() {
        if (isTrafficOn) { map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = false; }
        else { map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = true; }
    }

    /* -------------------------------------------
       [3] 시트 및 검색 로직
       ------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    /* -------------------------------------------
       [4] 핵심: 하이브리드 경로 검색
       ------------------------------------------- */
    async function runHybridSearch() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('출발/도착지를 입력하세요');

        // 1. 카카오 API로 장소 -> 좌표 변환
        const sCoord = await getKakaoCoords(sVal);
        const eCoord = await getKakaoCoords(eVal);
        
        if(!sCoord || !eCoord) return alert("장소를 찾을 수 없습니다. (정확한 명칭을 입력해주세요)");

        // 2. TMAP API로 경로 데이터 가져오기 & 그리기
        await fetchTmapDataAndRender(sCoord, eCoord);

        // 3. UI 업데이트
        searchForm.style.display = 'none';
        resultCard.classList.add('active');
    }

    // 카카오 장소 검색
    function getKakaoCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("현위치")) {
                navigator.geolocation.getCurrentPosition(pos => 
                    resolve({lng: pos.coords.longitude, lat: pos.coords.latitude, name: "내 위치"}));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) 
                        resolve({lng: parseFloat(data[0].x), lat: parseFloat(data[0].y), name: data[0].place_name});
                    else resolve(null);
                });
            }
        });
    }

    // TMAP 데이터 요청 -> 카카오 지도에 그리기
    async function fetchTmapDataAndRender(start, end) {
        // [수정] 최신 우회 서버 사용
        const proxy = 'https://corsproxy.io/?'; 
        const url = "https://apis.openapi.sk.com/transit/routes";
        
        const payload = {
            startX: start.lng, startY: start.lat,
            endX: end.lng, endY: end.lat,
            count: 1, format: "json"
        };

        // 전체 URL을 인코딩해서 프록시 뒤에 붙임
        const targetUrl = proxy + encodeURIComponent(url);

        try {
            const response = await fetch(targetUrl, {
                method: "POST",
                headers: { "appKey": TMAP_APP_KEY, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error("TMAP API Error:", await response.text());
                throw new Error("경로를 불러올 수 없습니다.");
            }

            const data = await response.json();
            
            if (!data.metaData || !data.metaData.plan) {
                alert("대중교통 경로를 찾을 수 없습니다.");
                return;
            }

            const itinerary = data.metaData.plan.itineraries[0];
            
            // 정보 업데이트
            const totalTime = Math.round(itinerary.totalTime / 60);
            const totalFare = itinerary.fare.regular.totalFare;
            document.getElementById('totalTime').innerText = `${totalTime}분`;
            document.getElementById('routeSummary').innerText = `요금 ${totalFare}원 • 환승 ${itinerary.transferCount}회`;

            // 초기화
            polylines.forEach(p => p.setMap(null)); polylines = [];
            markers.forEach(m => m.setMap(null)); markers = [];

            // 마커
            addMarker(start.lat, start.lng, 'start');
            addMarker(end.lat, end.lng, 'end');

            // 타임라인 생성
            const timelineBox = document.getElementById('routeTimeline');
            timelineBox.innerHTML = '';
            addTimelineItem(timelineBox, 'walk', '출발', start.name);

            // 경로 그리기
            const legs = itinerary.legs;
            const bounds = new kakao.maps.LatLngBounds(); 

            legs.forEach(leg => {
                // [수정] passShape가 있는 경우에만 그리기 (에러 방지)
                if (leg.passShape) {
                    const path = parseTmapShapeToKakao(leg.passShape);
                    
                    // path가 유효할 때만 그리기
                    if (path.length > 0) {
                        const color = leg.mode === 'WALK' ? '#8B95A1' : '#3182F6';
                        const style = leg.mode === 'WALK' ? 'shortdash' : 'solid';
                        const weight = leg.mode === 'WALK' ? 5 : 7; 

                        const polyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: weight, strokeColor: color,
                            strokeOpacity: 0.9, strokeStyle: style
                        });
                        polyline.setMap(map);
                        polylines.push(polyline);
                        
                        bounds.extend(path[0]);
                        bounds.extend(path[path.length-1]);
                    }
                }

                if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'bus', `${leg.route} 승차`, `${time}분 이동`);
                } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'walk', `도보 이동`, `${time}분`);
                }
            });

            addTimelineItem(timelineBox, 'walk', '도착', end.name);
            map.setBounds(bounds);

        } catch (e) {
            console.error(e);
            alert("경로 검색 중 오류가 발생했습니다.");
        }
    }

    // [핵심 수정] 에러 방지용 파싱 함수
    function parseTmapShapeToKakao(passShape) {
        // 데이터가 문자열이 아니면 빈 배열 반환 (에러 차단)
        if (!passShape || typeof passShape !== 'string') {
            return [];
        }

        const coords = passShape.split(' ');
        return coords.map(c => {
            const [lng, lat] = c.split(',');
            return new kakao.maps.LatLng(lat, lng);
        });
    }

    function addMarker(lat, lng, type) {
        const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lng),
            map: map
        });
        markers.push(marker);
    }

    function addTimelineItem(container, type, title, desc = "") {
        let dotClass = 't-dot walk';
        let colorStyle = '';
        if(type === 'bus') { dotClass = 't-dot bus'; colorStyle = 'color:#3182F6;'; }
        
        const html = `
            <div class="t-item">
                <div class="${dotClass}"></div>
                <div class="t-text" style="${colorStyle}">${title}</div>
                ${desc ? `<div class="t-sub">${desc}</div>` : ''}
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
</script>
