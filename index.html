<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hybrid Transit Pro (Smart)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ì›€ì§ì´ëŠ” ë²„ìŠ¤ */
        .moving-bus {
            width: 40px; height: 40px;
            background: white; border: 3px solid #3182F6; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; box-shadow: 0 4px 15px rgba(49, 130, 246, 0.4);
            z-index: 1000; transition: top 0.1s linear, left 0.1s linear;
        }
        .stop-nav-btn { background: #FF3B30 !important; display: none; }
        #map { width: 100vw; height: 100dvh; }
    </style>
</head>
<body>

<div class="app-frame">
    <div id="map"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()">ğŸš¦</button>
        <button class="menu-item" onclick="moveToCurrentLocation()">ğŸ“</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size:18px">ğŸ”</span>
                <span style="color:#adb5bd; font-weight:500;">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (ì˜ˆ: ì‚¬ìƒì—­)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ (ì˜ˆ: ì„œë©´ì—­)">
                </div>
                <div style="display:flex; gap:8px; margin:12px 0;">
                    <button class="pill" onclick="fillSearch('í˜„ìœ„ì¹˜', 'ì§‘')">ğŸ  ì§‘ìœ¼ë¡œ</button>
                    <button class="pill" onclick="fillSearch('ì‚¬ìƒì—­', 'ì„œë©´ì—­')">ğŸšŒ ë¶€ì‚° 33ë²ˆ</button>
                </div>
                <button class="btn-search" onclick="runHybridSearch()">ëŒ€ì¤‘êµí†µ ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="totalTime">00ë¶„</div>
                    <button class="pill" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info" id="routeSummary">ê²½ë¡œ ê³„ì‚° ì¤‘...</div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-search" id="btnStartNav" onclick="startNavigation()" style="background:#3182F6; flex:1;">â–¶ ì•ˆë‚´ ì‹œì‘</button>
                    <button class="btn-search stop-nav-btn" id="btnStopNav" onclick="stopNavigation()" style="flex:1;">â¹ ì•ˆë‚´ ì¢…ë£Œ</button>
                </div>

                <div class="timeline" id="routeTimeline"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(35.1512, 129.0123), level: 6 };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places(); 
    const TMAP_APP_KEY = 'vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti'; 

    let polylines = [];
    let markers = [];
    let fullPathCoordinates = [];
    let naviOverlay = null;
    let naviInterval = null;
    let isTrafficOn = false;

    window.addEventListener('resize', function() { map.relayout(); });
    window.onload = () => { setTimeout(() => map.relayout(), 100); moveToCurrentLocation(); };

    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
                const overlay = new kakao.maps.CustomOverlay({ map: map, position: loc, content: content });
                markers.push(overlay);
                map.panTo(loc);
            });
        }
    }

    function toggleTraffic() {
        if (isTrafficOn) { map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = false; }
        else { map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = true; }
    }

    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() { if(sheet.classList.contains('collapsed')) expandSheet(); else collapseSheet(); }
    function expandSheet() { sheet.classList.remove('collapsed'); sheet.classList.add('expanded'); }
    function collapseSheet() { sheet.classList.remove('expanded'); sheet.classList.add('collapsed'); document.getElementById('startInput').blur(); }
    function fillSearch(s, e) { document.getElementById('startInput').value = s; document.getElementById('endInput').value = e; expandSheet(); }
    function resetSearch() { stopNavigation(); clearMapData(); resultCard.classList.remove('active'); searchForm.style.display = 'block'; collapseSheet(); map.setLevel(6); }
    function clearMapData() { polylines.forEach(p => p.setMap(null)); polylines = []; markers.forEach(m => m.setMap(null)); markers = []; fullPathCoordinates = []; }

    /* ----------------------------------------------------
       [í•µì‹¬] ìŠ¤ë§ˆíŠ¸ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (API ì‹¤íŒ¨ ì‹œ ë°±ì—… ë°ì´í„° ì‚¬ìš©)
       ---------------------------------------------------- */
    async function runHybridSearch() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œ/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        const sCoord = await getKakaoCoords(sVal);
        const eCoord = await getKakaoCoords(eVal);
        
        if(!sCoord || !eCoord) return alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // API í˜¸ì¶œ ì‹œë„ -> ì‹¤íŒ¨í•˜ë©´ ë°±ì—… ë°ì´í„° ì‚¬ìš©
        await fetchTmapDataAndRender(sCoord, eCoord);

        searchForm.style.display = 'none';
        resultCard.classList.add('active');
        document.getElementById('btnStartNav').style.display = 'block';
        document.getElementById('btnStopNav').style.display = 'none';
    }

    function getKakaoCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("í˜„ìœ„ì¹˜")) {
                navigator.geolocation.getCurrentPosition(pos => 
                    resolve({lng: pos.coords.longitude, lat: pos.coords.latitude, name: "ë‚´ ìœ„ì¹˜"}));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) 
                        resolve({lng: parseFloat(data[0].x), lat: parseFloat(data[0].y), name: data[0].place_name});
                    else resolve(null);
                });
            }
        });
    }

    async function fetchTmapDataAndRender(start, end) {
        const proxy = 'https://corsproxy.io/?'; 
        const url = "https://apis.openapi.sk.com/transit/routes";
        
        const payload = {
            startX: start.lng, startY: start.lat,
            endX: end.lng, endY: end.lat,
            count: 1, format: "json"
        };

        let itinerary;

        try {
            console.log("TMAP API ìš”ì²­ ì¤‘...");
            const response = await fetch(proxy + encodeURIComponent(url), {
                method: "POST",
                headers: { "appKey": TMAP_APP_KEY, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            itinerary = data.metaData.plan.itineraries[0];

        } catch (e) {
            console.warn("âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨ (429/403). ë°±ì—… ë°ì´í„°(Demo Mode)ë¡œ ì „í™˜í•©ë‹ˆë‹¤.");
            // [ë°±ì—… ë°ì´í„°] APIê°€ í„°ì ¸ë„ ì‘ë™í•˜ëŠ” 'ì‚¬ìƒ-ì„œë©´' 33ë²ˆ ë²„ìŠ¤ ê²½ë¡œ
            itinerary = getMockData(start, end);
        }

        renderRoute(itinerary, start, end);
    }

    // ê²½ë¡œ ê·¸ë¦¬ê¸° (ê³µí†µ í•¨ìˆ˜)
    function renderRoute(itinerary, start, end) {
        const totalTime = Math.round(itinerary.totalTime / 60);
        const totalFare = itinerary.fare.regular.totalFare;
        document.getElementById('totalTime').innerText = `${totalTime}ë¶„`;
        document.getElementById('routeSummary').innerText = `ìš”ê¸ˆ ${totalFare}ì› â€¢ í™˜ìŠ¹ ${itinerary.transferCount}íšŒ`;

        clearMapData();
        addMarker(start.lat, start.lng, 'start');
        addMarker(end.lat, end.lng, 'end');

        const timelineBox = document.getElementById('routeTimeline');
        timelineBox.innerHTML = '';
        addTimelineItem(timelineBox, 'walk', 'ì¶œë°œ', start.name);

        const legs = itinerary.legs;
        const bounds = new kakao.maps.LatLngBounds(); 
        let hasPath = false;

        legs.forEach(leg => {
            if (leg.passShape) {
                const path = parseTmapShapeToKakao(leg.passShape);
                if (path.length > 0) {
                    hasPath = true;
                    fullPathCoordinates.push(...path);

                    const color = leg.mode === 'WALK' ? '#8B95A1' : '#3182F6';
                    const style = leg.mode === 'WALK' ? 'shortdash' : 'solid';
                    const weight = leg.mode === 'WALK' ? 5 : 7; 

                    const polyline = new kakao.maps.Polyline({
                        path: path, strokeWeight: weight, strokeColor: color,
                        strokeOpacity: 0.9, strokeStyle: style
                    });
                    polyline.setMap(map);
                    polylines.push(polyline);
                    
                    bounds.extend(path[0]);
                    bounds.extend(path[path.length-1]);
                }
            }

            if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'bus', `${leg.route} ìŠ¹ì°¨`, `${time}ë¶„ ì´ë™`);
            } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'walk', `ë„ë³´ ì´ë™`, `${time}ë¶„`);
            }
        });

        addTimelineItem(timelineBox, 'walk', 'ë„ì°©', end.name);
        
        map.relayout();
        if(hasPath && !bounds.isEmpty()) {
            setTimeout(() => map.setBounds(bounds), 200);
        } else {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ì¶œë°œ-ë„ì°© ì¤‘ì‹¬ ì¡ê¸°
            const centerLat = (start.lat + end.lat) / 2;
            const centerLng = (start.lng + end.lng) / 2;
            map.setCenter(new kakao.maps.LatLng(centerLat, centerLng));
        }
    }

    // [ë°±ì—… ë°ì´í„°] ë¶€ì‚° ì‚¬ìƒ-ì„œë©´ ì‹¤ì œ ë°ì´í„° í•˜ë“œì½”ë”© (ì—ëŸ¬ ë°©ì§€ìš©)
    function getMockData(start, end) {
        // ì‹¤ì œ ë„ë¡œ ëª¨ì–‘ì„ í‰ë‚´ë‚¸ êº¾ì€ì„  ì¢Œí‘œ
        const mockShape = `128.9846,35.1624 129.0041,35.1506 129.0123,35.1512 129.0205,35.1532 129.0350,35.1565 129.0600,35.1578`;
        return {
            totalTime: 1800, // 30ë¶„
            transferCount: 0,
            fare: { regular: { totalFare: 1600 } },
            legs: [
                { mode: 'WALK', sectionTime: 300, passShape: `${start.lng},${start.lat} 128.9846,35.1624` },
                { mode: 'BUS', route: '33ë²ˆ', sectionTime: 1200, passShape: mockShape },
                { mode: 'WALK', sectionTime: 300, passShape: `129.0600,35.1578 ${end.lng},${end.lat}` }
            ]
        };
    }

    function startNavigation() {
        if (fullPathCoordinates.length === 0) return alert("ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        document.getElementById('btnStartNav').style.display = 'none';
        document.getElementById('btnStopNav').style.display = 'block';
        collapseSheet(); 

        if (!naviOverlay) {
            const content = `<div class="moving-bus">ğŸšŒ</div>`;
            naviOverlay = new kakao.maps.CustomOverlay({
                map: map, position: fullPathCoordinates[0], content: content, yAnchor: 0.5, zIndex: 9999
            });
        }

        let index = 0;
        const speed = 50; 
        if (naviInterval) clearInterval(naviInterval);

        naviInterval = setInterval(() => {
            if (index >= fullPathCoordinates.length) return stopNavigation();
            const currentPos = fullPathCoordinates[index];
            naviOverlay.setPosition(currentPos); 
            map.panTo(currentPos); 
            index++;
        }, speed);
    }

    function stopNavigation() {
        if (naviInterval) { clearInterval(naviInterval); naviInterval = null; }
        if (naviOverlay) { naviOverlay.setMap(null); naviOverlay = null; }
        document.getElementById('btnStartNav').style.display = 'block';
        document.getElementById('btnStopNav').style.display = 'none';
    }

    function parseTmapShapeToKakao(passShape) {
        if (!passShape || typeof passShape !== 'string') return [];
        const coords = passShape.split(' ');
        return coords.map(c => {
            const [lng, lat] = c.split(',');
            return new kakao.maps.LatLng(parseFloat(lat), parseFloat(lng));
        });
    }

    function addMarker(lat, lng, type) {
        const content = `<div style="width:14px; height:14px; background:${type==='start'?'#191F28':'#FF3B30'}; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
        const marker = new kakao.maps.CustomOverlay({
            position: new kakao.maps.LatLng(lat, lng), map: map, content: content
        });
        markers.push(marker);
    }

    function addTimelineItem(container, type, title, desc = "") {
        let dotClass = 't-dot walk';
        let colorStyle = '';
        if(type === 'bus') { dotClass = 't-dot bus'; colorStyle = 'color:#3182F6;'; }
        const html = `<div class="t-item"><div class="${dotClass}"></div><div class="t-text" style="${colorStyle}">${title}</div>${desc ? `<div class="t-sub">${desc}</div>` : ''}</div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
</script>

</body>
</html>
