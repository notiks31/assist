<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í™˜ìŠ¹ ì–´ì‹œìŠ¤íŠ¸ (Transfer Assist)</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        .realtime-clock-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px; border-radius: 20px;
            font-weight: 800; font-size: 14px; color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="top-map-area">
        <div class="realtime-clock-overlay">
            ğŸ•’ <span id="clock-text">00:00:00</span>
        </div>

        <div id="map" style="width:100%; height:100%;"></div>

        <div class="map-badge" id="map-status-text">ğŸ“ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>

        <button class="bus-test-btn" onclick="getRealBusData()">ğŸšŒ ë²„ìŠ¤ ë³´ê¸° (ì‹¤ì‹œê°„)</button>
    </div>

    <div class="bottom-content-area">

        <div id="step-1" class="screen active">
            <div class="content-header">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</div>
            
            <div class="input-group">
                <div class="input-box">
                    <span>ğŸ”µ</span> 
                    <input type="text" id="start-input" placeholder="ì¶œë°œì§€ (ì˜ˆ: ë¶€ì‚°ì—­)" onkeyup="handleEnter(event)">
                </div>
            </div>

            <div class="input-group">
                <div class="input-box">
                    <span>ğŸ”´</span> 
                    <input type="text" id="end-input" placeholder="ë„ì°©ì§€ (ì˜ˆ: ê´‘ì•ˆë¦¬)" onkeyup="handleEnter(event)">
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="favorite-box">
                    <div style="flex:1;" onclick="useFavorite()">
                        <span>â­</span> 
                        <span id="fav-title" style="font-weight:bold; margin-left:5px;">ì§‘ â†’ í•™êµ</span><br>
                        <span id="fav-desc" style="font-size:11px; color:#aaa; margin-left:25px;">33ë²ˆ ë²„ìŠ¤ ì´ìš©</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="findRouteOnMap()">ê²½ë¡œ ì°¾ê¸°</button>
        </div>

        <div id="step-2" class="screen">
            <div class="content-header">
                <span>ê²½ë¡œ íƒìƒ‰ ê²°ê³¼</span>
                <span style="font-size:14px; color:var(--primary);">ì§€ë„ í™•ì¸</span>
            </div>

            <div class="timeline-container">
                <div class="timeline-left">
                    <span class="timeline-time" id="start-time-text">--:--</span>
                    <div class="timeline-dot active"></div>
                    <div class="timeline-line active"></div>
                </div>
                <div class="timeline-right">
                    <div class="location-title" id="res-start-text">ì¶œë°œì§€</div>
                </div>

                <div class="timeline-left">
                    <div class="timeline-line active"></div>
                    <span class="timeline-icon">ğŸšŒ</span>
                </div>
                <div class="timeline-right">
                    <div class="location-title">ì´ë™ ì¤‘</div>
                    <div class="location-desc">ì§€ë„ì— í‘œì‹œëœ ê²½ë¡œë¥¼ ë”°ë¼ ì´ë™í•©ë‹ˆë‹¤.</div>
                </div>

                <div class="timeline-left">
                    <div class="timeline-dot"></div>
                </div>
                <div class="timeline-right">
                    <div class="location-title" id="res-end-text">ë„ì°©ì§€</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="goToStep(3)">ì•ˆë‚´ ì‹œì‘</button>
            <button class="btn btn-outline" onclick="goToStep(1)">ë‹¤ì‹œ ê²€ìƒ‰</button>
        </div>

        <div id="step-3" class="screen">
            <div class="content-header">ì•ˆë‚´ ì¤‘</div>
            <div style="text-align:center; padding-top:50px;">
                <h3>ì•ˆì „í•˜ê²Œ ì´ë™í•˜ì„¸ìš”!</h3>
                <p style="color:#888;">ì§€ë„ë¥¼ ë³´ê³  ì´ë™ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <button class="btn btn-primary" onclick="goToStep(1)">ì•ˆë‚´ ì¢…ë£Œ</button>
            </div>
        </div>

    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* =========================================
       [ê¸°ëŠ¥ 1] ì‹¤ì‹œê°„ ì‹œê³„ (ì´ˆ ë‹¨ìœ„ ê°±ì‹ )
       ========================================= */
    function startClock() {
        const clockTarget = document.getElementById("clock-text");
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { hour12: false });
            clockTarget.innerText = timeString;
        }, 1000);
    }
    startClock(); // ì‹œê³„ ì‹œì‘


    /* =========================================
       [ê¸°ëŠ¥ 2] ì§€ë„ ë° ì¥ì†Œ ê²€ìƒ‰ (ì§„ì§œ ì§€ë„ ì—°ë™)
       ========================================= */
    var mapContainer = document.getElementById('map');
    var mapOption = { 
        center: new kakao.maps.LatLng(35.1512, 129.0123), 
        level: 7 
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    
    // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´
    var ps = new kakao.maps.services.Places(); 
    
    // ë§ˆì»¤ì™€ ì„ ì„ ë‹´ì•„ë‘˜ ë³€ìˆ˜ (ê²€ìƒ‰í•  ë•Œë§ˆë‹¤ ì§€ìš°ê¸° ìœ„í•´)
    var markers = [];
    var polyline = null;

    // ê²½ë¡œ ì°¾ê¸° ì‹¤í–‰ í•¨ìˆ˜
    async function findRouteOnMap() {
        const startKeyword = document.getElementById('start-input').value;
        const endKeyword = document.getElementById('end-input').value;

        if(!startKeyword || !endKeyword) {
            alert("ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // 1. ê¸°ì¡´ ë§ˆì»¤/ì„  ì§€ìš°ê¸°
        removeMarkers();
        if(polyline) polyline.setMap(null);

        try {
            document.getElementById('map-status-text').innerText = "ğŸ” ìœ„ì¹˜ ê²€ìƒ‰ ì¤‘...";
            
            // 2. ì¶œë°œì§€, ë„ì°©ì§€ ì¢Œí‘œ ê²€ìƒ‰ (ë¹„ë™ê¸° ì²˜ë¦¬)
            const startCoords = await searchLocation(startKeyword);
            const endCoords = await searchLocation(endKeyword);

            if(!startCoords || !endCoords) {
                alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì§€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                document.getElementById('map-status-text').innerText = "âŒ ê²€ìƒ‰ ì‹¤íŒ¨";
                return;
            }

            // 3. ì§€ë„ì— ë§ˆì»¤ ì°ê¸°
            addMarker(startCoords, "ì¶œë°œ: " + startKeyword, "ğŸ”µ");
            addMarker(endCoords, "ë„ì°©: " + endKeyword, "ğŸ”´");

            // 4. ë‘ ì§€ì ì„ ì‡ëŠ” ì„  ê·¸ë¦¬ê¸° (ì§ì„ )
            // (ì°¸ê³ : ì‹¤ì œ ë„ë¡œ ê²½ë¡œëŠ” ì¹´ì¹´ì˜¤ ëª¨ë¹Œë¦¬í‹° ìœ ë£Œ APIê°€ í•„ìš”í•˜ë¯€ë¡œ, ì—¬ê¸°ì„  ì§ì„ ìœ¼ë¡œ í‘œí˜„ë©ë‹ˆë‹¤)
            var linePath = [ startCoords, endCoords ];
            polyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: '#6A67CE',
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });
            polyline.setMap(map);

            // 5. ë‘ ì§€ì ì´ ë‹¤ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¬ì„¤ì • (Bounds)
            var bounds = new kakao.maps.LatLngBounds();
            bounds.extend(startCoords);
            bounds.extend(endCoords);
            map.setBounds(bounds);

            // 6. í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° í™”ë©´ ì „í™˜
            document.getElementById('res-start-text').innerText = startKeyword;
            document.getElementById('res-end-text').innerText = endKeyword;
            
            const now = new Date();
            document.getElementById('start-time-text').innerText = 
                String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');

            document.getElementById('map-status-text').innerText = "ğŸ—ºï¸ ê²½ë¡œ í‘œì‹œ ì™„ë£Œ";
            goToStep(2);

        } catch (err) {
            console.error(err);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì¥ì†Œ ê²€ìƒ‰ í—¬í¼ í•¨ìˆ˜ (Promise ì‚¬ìš©)
    function searchLocation(keyword) {
        return new Promise((resolve, reject) => {
            ps.keywordSearch(keyword, (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    // ê²€ìƒ‰ ê²°ê³¼ ì¤‘ ì²« ë²ˆì§¸(ê°€ì¥ ì •í™•í•œ) ì¢Œí‘œ ë°˜í™˜
                    resolve(new kakao.maps.LatLng(data[0].y, data[0].x));
                } else {
                    resolve(null); // ê²€ìƒ‰ ì‹¤íŒ¨
                }
            });
        });
    }

    // ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
    function addMarker(position, title, iconType) {
        var marker = new kakao.maps.Marker({
            position: position,
            map: map,
            title: title
        });
        markers.push(marker);
    }

    function removeMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }

    function handleEnter(e) {
        if(e.key === 'Enter') findRouteOnMap();
    }


    /* =========================================
       [ê¸°ëŠ¥ 3] ì‹¤ì œ ë²„ìŠ¤ ë°ì´í„° (CORS ìš°íšŒ)
       ========================================= */
    var busMarkers = []; 

    async function getRealBusData() {
        const statusText = document.getElementById('map-status-text');
        
        // ğŸš¨ [í•„ìˆ˜] ì—¬ê¸°ì— ê³µê³µë°ì´í„°í¬í„¸ [Decoding] ì¸ì¦í‚¤ ì…ë ¥ ğŸš¨
        const serviceKey = '1fe0be0bcba2e3e38d12218b55ae1e841ae702d4290b2b21c9926f38d7c34c1b'; 
        
        const lineId = '5200033000'; // 33ë²ˆ ë²„ìŠ¤
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const apiUrl = `http://apis.data.go.kr/6260000/BusanBims/busInfoByRouteId?serviceKey=${serviceKey}&lineId=${lineId}&numOfRows=10&pageNo=1`;

        try {
            statusText.innerText = "ğŸ“¡ ë²„ìŠ¤ ë°ì´í„° ìˆ˜ì‹  ì¤‘...";
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
            
            const str = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(str, "text/xml");

            // ê¸°ì¡´ ë²„ìŠ¤ ì‚­ì œ
            for(var bm of busMarkers) bm.setMap(null);
            busMarkers = [];

            const items = xmlDoc.getElementsByTagName("item");
            if (!items || items.length === 0) {
                statusText.innerText = "âš ï¸ ìš´í–‰ ë²„ìŠ¤ ì—†ìŒ";
                alert("ìš´í–‰ ì¤‘ì¸ ë²„ìŠ¤ê°€ ì—†ê±°ë‚˜ ì¸ì¦í‚¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
                return;
            }

            for (let i = 0; i < items.length; i++) {
                const lat = items[i].getElementsByTagName("lat")[0].textContent;
                const lng = items[i].getElementsByTagName("lng")[0].textContent;
                const carNo = items[i].getElementsByTagName("carNo")[0].textContent;

                var busPos = new kakao.maps.LatLng(lat, lng);
                var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/busStop.png', 
                    imageSize = new kakao.maps.Size(24, 35); 
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                var marker = new kakao.maps.Marker({
                    position: busPos,
                    image: markerImage,
                    map: map,
                    title: carNo
                });
                busMarkers.push(marker);
            }
            statusText.innerText = `ğŸšŒ ${items.length}ëŒ€ ìš´í–‰ ì¤‘`;
            
            // ì²« ë²ˆì§¸ ë²„ìŠ¤ë¡œ ì´ë™
            if(items.length > 0) {
                 const firstLat = items[0].getElementsByTagName("lat")[0].textContent;
                 const firstLng = items[0].getElementsByTagName("lng")[0].textContent;
                 map.panTo(new kakao.maps.LatLng(firstLat, firstLng));
            }

        } catch (error) {
            console.error(error);
            alert("ë²„ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸ì¦í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }
    }


    /* =========================================
       [ê¸°íƒ€ UI ë¡œì§]
       ========================================= */
    function useFavorite() {
        document.getElementById('start-input').value = "ëƒ‰ì •ì—­";
        document.getElementById('end-input').value = "ë™ì˜ëŒ€í•™êµ";
        findRouteOnMap(); // ë°”ë¡œ ê²€ìƒ‰ ì‹¤í–‰
    }

    function goToStep(stepNumber) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        const targetScreen = document.getElementById(`step-${stepNumber}`);
        if(targetScreen) targetScreen.classList.add('active');
    }
</script>

</body>
</html>
