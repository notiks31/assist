<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Clean Map App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-frame">
    
    <div id="map"></div>

    <div class="top-controls">
        <button class="pill-btn" onclick="toggleAmenities()">
            <span>ğŸª</span> í¸ì˜ì 
        </button>
        
        <div class="top-right">
            <button class="pill-btn" onclick="toggleTraffic()" title="êµí†µìƒí™©">
                ğŸš¦ êµí†µ
            </button>
        </div>
    </div>

    <button class="my-loc-btn" onclick="moveToCurrentLocation()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 2v20M2 12h20"/>
        </svg>
    </button>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div id="view-default">
                <div class="sheet-title" onclick="expandSheet()">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</div>
                
                <div class="input-container" onclick="expandSheet()" style="cursor: pointer;">
                    <div class="input-row" style="border:none;">
                        <span style="margin-right:10px; font-size:18px;">ğŸ”</span>
                        <span style="color:#ADB5BD; font-weight:500;">ì¥ì†Œ, ë²„ìŠ¤, ì§€í•˜ì²  ê²€ìƒ‰</span>
                    </div>
                </div>

                <div class="chip-group">
                    <div class="chip blue" onclick="fillAndSearch('í˜„ìœ„ì¹˜', 'ì§‘')">ğŸ  ì§‘ìœ¼ë¡œ</div>
                    <div class="chip" onclick="fillAndSearch('í˜„ìœ„ì¹˜', 'íšŒì‚¬')">ğŸ¢ íšŒì‚¬ë¡œ</div>
                    <div class="chip" onclick="fillAndSearch('ë¶€ì‚°ì—­', 'ê´‘ì•ˆë¦¬')">ğŸŒŠ ê´‘ì•ˆë¦¬</div>
                </div>
            </div>

            <div id="view-expanded" class="hidden">
                <div class="sheet-title">ê²½ë¡œ ê²€ìƒ‰</div>
                
                <div class="input-container">
                    <div class="input-row">
                        <div class="dot start"></div>
                        <input type="text" id="startInput" class="input-field" placeholder="ì¶œë°œì§€ ì…ë ¥">
                    </div>
                    <div class="input-row">
                        <div class="dot end"></div>
                        <input type="text" id="endInput" class="input-field" placeholder="ë„ì°©ì§€ ì…ë ¥">
                    </div>
                </div>

                <div class="chip-group">
                    <div class="chip" onclick="setInput('startInput', 'ë‚´ ìœ„ì¹˜')">ğŸ“ ë‚´ ìœ„ì¹˜</div>
                    <div class="chip" onclick="setInput('endInput', 'ì„œë©´ ë¡¯ë°ë°±í™”ì ')">ğŸ›ï¸ ì„œë©´ ë¡¯ë°</div>
                    <div class="chip" onclick="setInput('endInput', 'ë¶€ì‚°ëŒ€í•™êµ')">ğŸ“ ë¶€ì‚°ëŒ€</div>
                </div>

                <button class="btn-primary" onclick="findPath()">ê²½ë¡œ í™•ì¸í•˜ê¸°</button>
            </div>

            <div id="resultCard" class="result-card">
                <div class="route-header">
                    <div>
                        <span class="time-display" id="timeDisplay">24ë¶„</span>
                        <span class="time-sub" id="distanceDisplay">3.5km</span>
                    </div>
                    <button class="chip" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>

                <div class="timeline">
                    <div class="t-item">
                        <div class="t-dot start"></div>
                        <div class="t-title" id="resStart">ì¶œë°œì§€</div>
                        <div class="t-desc">ë„ë³´ ì´ë™</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot" style="background:#E5E8EB; border:none; width:6px; height:6px; left:-17px;"></div>
                        <div class="t-title" style="color:var(--primary);">33ë²ˆ ë²„ìŠ¤</div>
                        <div class="t-desc">ì•½ 18ë¶„ íƒ‘ìŠ¹</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot end"></div>
                        <div class="t-title" id="resEnd">ë„ì°©ì§€</div>
                    </div>
                </div>
                
                <button class="btn-primary" style="margin-top:10px;" onclick="resetSearch()">ì•ˆë‚´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* ---------------------------------------------
       [1] ì§€ë„ ì—”ì§„ ì´ˆê¸°í™”
       --------------------------------------------- */
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(35.1512, 129.0123), level: 5 }; // ë¶€ì‚° ëƒ‰ì •ì—­ ë¶€ê·¼
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places();
    
    let markers = [];
    let polylines = [];
    let currentOverlayType = null;

    // ì‹œì‘ ì‹œ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
    window.onload = () => moveToCurrentLocation();

    /* ---------------------------------------------
       [2] Bottom Sheet UX ë¡œì§
       --------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const viewDefault = document.getElementById('view-default');
    const viewExpanded = document.getElementById('view-expanded');
    const resultCard = document.getElementById('resultCard');

    function toggleSheet() {
        if (sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }

    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
        
        // ë·° ì „í™˜ (ê¸°ë³¸ -> ì…ë ¥í¼)
        if (resultCard.classList.contains('active')) return; // ê²°ê³¼ì°½ ìˆìœ¼ë©´ ìœ ì§€
        viewDefault.classList.add('hidden');
        viewExpanded.classList.remove('hidden');
    }

    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        
        // í‚¤ë³´ë“œ ë‚´ë¦¬ê¸°
        document.getElementById('startInput').blur();
        document.getElementById('endInput').blur();

        // ë·° ë³µêµ¬ (ê²°ê³¼ì°½ ì—†ì„ ë•Œë§Œ)
        if (!resultCard.classList.contains('active')) {
            setTimeout(() => {
                viewDefault.classList.remove('hidden');
                viewExpanded.classList.add('hidden');
            }, 300);
        }
    }

    function setInput(id, val) {
        document.getElementById(id).value = val;
    }

    function fillAndSearch(s, e) {
        setInput('startInput', s);
        setInput('endInput', e);
        expandSheet();
        findPath();
    }

    function resetSearch() {
        // ë§µ í´ë¦¬ì–´
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
        
        // UI ì´ˆê¸°í™”
        resultCard.classList.remove('active');
        viewExpanded.classList.remove('hidden'); // ë‹¤ì‹œ ì…ë ¥í¼ìœ¼ë¡œ
        setInput('startInput', '');
        setInput('endInput', '');
        collapseSheet(); // ë‚´ë ¤ê°€ê¸°
    }

    /* ---------------------------------------------
       [3] ê¸°ëŠ¥: ë‚´ ìœ„ì¹˜ / í¸ì˜ì  / êµí†µ
       --------------------------------------------- */
    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const locPosition = new kakao.maps.LatLng(lat, lng);
                
                // íŒŒë€ ì  ë§ˆì»¤ (ì¡ë‹¤/í† ìŠ¤ ìŠ¤íƒ€ì¼)
                const content = `
                    <div style="
                        width: 18px; height: 18px; 
                        background: #3182F6; 
                        border: 3px solid white; 
                        border-radius: 50%; 
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                    </div>`;
                const customOverlay = new kakao.maps.CustomOverlay({ position: locPosition, content: content });
                customOverlay.setMap(map);
                map.panTo(locPosition);
            });
        }
    }

    function toggleAmenities() {
        markers.forEach(m => m.setMap(null)); markers = [];
        // CS2: í¸ì˜ì 
        ps.categorySearch('CS2', (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const bounds = new kakao.maps.LatLngBounds();
                data.forEach(place => {
                    const marker = new kakao.maps.Marker({
                        map: map, position: new kakao.maps.LatLng(place.y, place.x)
                    });
                    markers.push(marker);
                    bounds.extend(new kakao.maps.LatLng(place.y, place.x));
                });
                map.setBounds(bounds);
            }
        }, { useMapBounds: true });
    }

    function toggleTraffic() {
        if (currentOverlayType === 'traffic') {
            map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            currentOverlayType = null;
        } else {
            map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            currentOverlayType = 'traffic';
        }
    }

    /* ---------------------------------------------
       [4] ê¸°ëŠ¥: ìŠ¤ë§ˆíŠ¸ ê²½ë¡œ ê²€ìƒ‰ (ë„ë¡œ ê·¸ë¦¬ê¸°)
       --------------------------------------------- */
    async function findPath() {
        const startVal = document.getElementById('startInput').value;
        const endVal = document.getElementById('endInput').value;

        if (!startVal || !endVal) { alert("ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        // 1. ì¢Œí‘œ ê²€ìƒ‰
        const startCoords = await getCoords(startVal);
        const endCoords = await getCoords(endVal);

        if (!startCoords || !endCoords) { alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

        // 2. ê±°ë¦¬ ê³„ì‚° ë° ê·¸ë¦¬ê¸°
        const distance = getDistance(startCoords, endCoords);
        drawPath(startCoords, endCoords, distance);

        // 3. ê²°ê³¼ UI í‘œì‹œ
        viewExpanded.classList.add('hidden'); // ì…ë ¥í¼ ìˆ¨ê¹€
        resultCard.classList.add('active');   // ê²°ê³¼ì¹´ë“œ í‘œì‹œ
        
        document.getElementById('resStart').innerText = startVal;
        document.getElementById('resEnd').innerText = endVal;
        document.getElementById('distanceDisplay').innerText = distance.toFixed(1) + "km";
        
        // ì‹œê°„ ê³„ì‚° ì‹œë®¬ë ˆì´ì…˜
        const min = Math.round(distance * 3 + 10);
        document.getElementById('timeDisplay').innerText = min + "ë¶„";
    }

    function getCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("í˜„ìœ„ì¹˜") || keyword.includes("ë‚´ ìœ„ì¹˜")) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => resolve(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)));
                }
                return;
            }
            ps.keywordSearch(keyword, (data, status) => {
                if (status === kakao.maps.services.Status.OK) resolve(new kakao.maps.LatLng(data[0].y, data[0].x));
                else resolve(null);
            });
        });
    }

    function drawPath(start, end, distKm) {
        // ê¸°ì¡´ ì„  ì œê±°
        polylines.forEach(p => p.setMap(null)); polylines = [];

        // ë§ˆì»¤
        new kakao.maps.Marker({ map: map, position: start });
        new kakao.maps.Marker({ map: map, position: end });

        // 'ã„±'ì êº¾ì„ ê²½ë¡œ ì‹œë®¬ë ˆì´ì…˜
        const mid = new kakao.maps.LatLng(start.getLat(), end.getLng());
        const path = [start, mid, end];

        const polyline = new kakao.maps.Polyline({
            path: path,
            strokeWeight: 6,
            strokeColor: '#3182F6', // Primary Blue
            strokeOpacity: 0.9,
            strokeStyle: 'solid'
        });
        polyline.setMap(map);
        polylines.push(polyline);

        // ë·°í¬íŠ¸ ì¡°ì •
        const bounds = new kakao.maps.LatLngBounds();
        bounds.extend(start); bounds.extend(end); bounds.extend(mid);
        map.setBounds(bounds);
    }

    function getDistance(p1, p2) {
        // ê°„ë‹¨í•œ ê±°ë¦¬ ê³„ì‚° (km)
        const R = 6371;
        const dLat = (p2.getLat() - p1.getLat()) * Math.PI / 180;
        const dLon = (p2.getLng() - p1.getLng()) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(p1.getLat() * Math.PI / 180) * Math.cos(p2.getLat() * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
</script>

</body>
</html>
