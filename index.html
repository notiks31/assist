<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Hybrid Transit Pro (최종 통합)</title>
    
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <style>
        /* -------------------------------------------
           [기존 스타일 + 카테고리 검색 스타일 통합]
           ------------------------------------------- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
        
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #f5f6f8; }

        /* 지도 영역 */
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }

        /* 플로팅 메뉴 */
        .floating-menu {
            position: absolute; top: 16px; right: 16px; z-index: 10;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .menu-item {
            width: 44px; height: 44px; border-radius: 50%; background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: none; font-size: 20px;
            display: none; align-items: center; justify-content: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-item:active { transform: scale(0.95); }
        .floating-menu.open .menu-item { display: flex; }
        .toggle-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #3182F6; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: none; display: flex;
            align-items: center; justify-content: center; cursor: pointer; z-index: 11;
        }
        .toggle-btn svg { width: 24px; height: 24px; fill: currentColor; transition: transform 0.3s; }
        .floating-menu.open .toggle-btn svg { transform: rotate(45deg); }

        /* 바텀 시트 */
        .bottom-sheet {
            position: fixed; left: 0; right: 0; bottom: 0; background: white;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 20;
            transition: transform 0.3s ease-out;
            transform: translateY(calc(100% - 100px)); 
            padding: 20px;
            box-sizing: border-box;
            z-index: 20;
        }
        .bottom-sheet.expanded {
            transform: translateY(0);
            height: 80%; 
            overflow-y: auto;
        }
        .drag-handle {
            width: 40px; height: 5px; background: #ccc; border-radius: 5px;
            margin: 0 auto 15px; cursor: grab;
        }
        
        /* 입력 필드 및 버튼 스타일 */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        #searchButton { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        #searchButton:hover { background-color: #0056b3; }
        
        /* 실시간 검색 결과 추천 목록 스타일 */
        .search-results {
            position: absolute;
            z-index: 30; 
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            display: none; 
            box-sizing: border-box;
        }
        .search-results ul { list-style: none; padding: 0; margin: 0; }
        .search-results li { padding: 12px 15px; font-size: 15px; color: #333; border-bottom: 1px solid #f2f4f6; cursor: pointer; box-sizing: border-box; }
        .search-results li:hover { background: #f8f8f8; }
        .search-results li:last-child { border-bottom: none; }
        .search-address { font-size: 12px; color: #8b95a1; display: block; margin-top: 2px; }

        /* 카테고리 검색 필터 스타일 */
        #category {position:absolute;top:10px;left:10px;border-radius: 5px; border:1px solid #909090;box-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);background: #fff;overflow: hidden;z-index: 2;}
        #category li {float:left;list-style: none;width:50px;px;border-right:1px solid #acacac;padding:6px 0;text-align: center; cursor: pointer;}
        #category li.on {background: #eee;}
        #category li:hover {background: #ffe6e6;border-left:1px solid #acacac;margin-left: -1px;}
        #category li:last-child{margin-right:0;border-right:0;}
        #category li span {display: block;margin:0 auto 3px;width:27px;height: 28px;}
        #category li .category_bg {background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png) no-repeat;}
        #category li .bank {background-position: -10px 0;}
        #category li .mart {background-position: -10px -36px;}
        #category li .pharmacy {background-position: -10px -72px;}
        #category li .oil {background-position: -10px -108px;}
        #category li .cafe {background-position: -10px -144px;}
        #category li .store {background-position: -10px -180px;}
        #category li.on .category_bg {background-position-x:-46px;}
        .placeinfo_wrap {position:absolute;bottom:28px;left:-150px;width:300px;}.placeinfo {position:relative;width:100%;border-radius:6px;border: 1px solid #ccc;border-bottom:2px solid #ddd;padding-bottom: 10px;background: #fff;}.placeinfo:nth-of-type(n) {border:0; box-shadow:0px 1px 2px #888;}.placeinfo_wrap .after {content:'';position:relative;margin-left:-12px;left:50%;width:22px;height:12px;background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')}.placeinfo a, .placeinfo a:hover, .placeinfo a:active{color:#fff;text-decoration: none;}.placeinfo a, .placeinfo span {display: block;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;}.placeinfo span {margin:5px 5px 0 5px;cursor: default;font-size:13px;}.placeinfo .title {font-weight: bold; font-size:14px;border-radius: 6px 6px 0 0;margin: -1px -1px 0 -1px;padding:10px; color: #fff;background: #d95050;background: #d95050 url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png) no-repeat right 14px center;}.placeinfo .tel {color:#0f7833;}.placeinfo .jibun {color:#999;font-size:11px;margin-top:0;}

    </style>
</head>
<body>
    <div id="map"></div>
    
    <ul id="category">
        <li id="BK9" data-order="0"> 
            <span class="category_bg bank"></span>
            은행
        </li>       
        <li id="MT1" data-order="1"> 
            <span class="category_bg mart"></span>
            마트
        </li>  
        <li id="PM9" data-order="2"> 
            <span class="category_bg pharmacy"></span>
            약국
        </li>  
        <li id="OL7" data-order="3"> 
            <span class="category_bg oil"></span>
            주유소
        </li>  
        <li id="CE7" data-order="4"> 
            <span class="category_bg cafe"></span>
            카페
        </li>  
        <li id="CS2" data-order="5"> 
            <span class="category_bg store"></span>
            편의점
        </li>      
    </ul>
    
    <div id="bottomSheet" class="collapsed">
        <div class="drag-handle" onclick="toggleSheet()"></div>
        
        <div class="app-frame">
            <div class="input-group">
                <input type="text" id="startInput" placeholder="출발지 (예: 서울역)">
                <input type="text" id="endInput" placeholder="도착지 (예: 강남역)">
                <button id="searchButton" onclick="runHybridSearch()">검색</button>
            </div>
            
            <div id="search-results-start" class="search-results"></div>
            <div id="search-results-end" class="search-results"></div>
            
            <div id="resultsContainer">
                </div>
            
        </div>
    </div>
    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>
    
    <script>
        // *** [새 변수] 카테고리 검색 관련 변수 ***
        var placeOverlay = new kakao.maps.CustomOverlay({zIndex:1}),
            contentNode = document.createElement('div'), 
            categoryMarkers = [], // 카테고리 검색 마커 배열 (기존 markers와 분리)
            currCategory = ''; // 현재 선택된 카테고리
            
        // *** 1. 상수 및 전역 변수 설정 ***
        
        // Vercel 배포 도메인 주소 (이미 최종 수정됨)
        const myServerUrl = "https://assist-jxup4d30i-notiks-projects.vercel.app/api/proxy";
        
        const mapContainer = document.getElementById('map');
        const bottomSheet = document.getElementById('bottomSheet');
        const resultsContainer = document.getElementById('resultsContainer');
        const mapOptions = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
            level: 5 // 지도의 확대 레벨
        };
        
        const map = new kakao.maps.Map(mapContainer, mapOptions);
        const ps = new kakao.maps.services.Places(map); // 카카오 장소 검색 객체
        const geocoder = new kakao.maps.services.Geocoder(); 
        const markers = []; // 기존 마커 배열 (Transit 마커, 현위치 마커용)
        let mapLoaded = false;
        
        // HTML 요소 변수
        const startInput = document.getElementById('startInput');
        const endInput = document.getElementById('endInput');
        const startResults = document.getElementById('search-results-start');
        const endResults = document.getElementById('search-results-end');

        // 커스텀 오버레이 설정
        contentNode.className = 'placeinfo_wrap';
        placeOverlay.setContent(contentNode);

        // 지도 유휴(idle) 이벤트 등록 (카테고리 검색용)
        kakao.maps.event.addListener(map, 'idle', searchPlaces);

        // 지도 로드 완료 시
        kakao.maps.event.addListener(map, 'tilesloaded', function() {
            if (!mapLoaded) {
                console.log('Kakao Map Loaded');
                mapLoaded = true;
            }
        });
        
        // *** 2. UI 및 이벤트 핸들러 ***
        
        // 바텀 시트 토글 기능
        function toggleSheet() {
            bottomSheet.classList.toggle('expanded');
        }
        
        function expandSheet() {
            if (!bottomSheet.classList.contains('expanded')) {
                bottomSheet.classList.add('expanded');
            }
        }
        
        // *** 3. 카테고리 검색 로직 (새로 통합된 기능) ***

        // 엘리먼트에 이벤트 핸들러를 등록하는 함수
        function addEventHandle(target, type, callback) {    
            if (target.addEventListener) { target.addEventListener(type, callback); } 
            else { target.attachEvent('on' + type, callback); }
        }
        
        // 커스텀 오버레이 컨텐츠 노드에 이벤트 등록 (지도 객체 이벤트 전달 방지)
        addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
        addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);

        // 카테고리 검색을 요청하는 함수
        function searchPlaces() {
            if (!currCategory) { return; }        
            placeOverlay.setMap(null);
            removeCategoryMarker(); // 카테고리 마커만 제거
            ps.categorySearch(currCategory, placesSearchCB, {useMapBounds:true}); 
        }

        // 장소검색 완료 콜백함수
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                displayPlaces(data);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                // 검색 결과 없음 처리
            } else if (status === kakao.maps.services.Status.ERROR) {
                // 에러 처리
            }            
        }

        // 지도에 마커를 표출하는 함수
        function displayPlaces(places) {
            var order = document.getElementById(currCategory).getAttribute('data-order');
            for ( var i=0; i<places.length; i++ ) {
                var marker = addCategoryMarker(new kakao.maps.LatLng(places[i].y, places[i].x), order);
                (function(marker, place) {
                    kakao.maps.event.addListener(marker, 'click', function() {
                        displayPlaceInfo(place);
                    });
                })(marker, places[i]);
            }
        }

        // 마커를 생성하고 지도 위에 마커를 표시하는 함수
        function addCategoryMarker(position, order) {
            var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png',
                imageSize = new kakao.maps.Size(27, 28),
                imgOptions =  {
                    spriteSize : new kakao.maps.Size(72, 208), 
                    spriteOrigin : new kakao.maps.Point(46, (order*36)), 
                    offset: new kakao.maps.Point(11, 28) 
                },
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),            
                marker = new kakao.maps.Marker({
                    position: position, 
                    image: markerImage         
                });
            marker.setMap(map); 
            categoryMarkers.push(marker); 
            return marker;
        }

        // 카테고리 마커를 모두 제거합니다.
        function removeCategoryMarker() {
            for ( var i = 0; i < categoryMarkers.length; i++ ) {
                categoryMarkers[i].setMap(null);
            }       
            categoryMarkers = [];
        }

        // 클릭한 마커에 대한 장소 상세정보를 커스텀 오버레이로 표시하는 함수
        function displayPlaceInfo (place) {
            var content = '<div class="placeinfo">' +
                            '   <a class="title" href="' + place.place_url + '" target="_blank" title="' + place.place_name + '">' + place.place_name + '</a>';
            if (place.road_address_name) {
                content += '    <span title="' + place.road_address_name + '">' + place.road_address_name + '</span>' +
                            '  <span class="jibun" title="' + place.address_name + '">(지번 : ' + place.address_name + ')</span>';
            }  else {
                content += '    <span title="' + place.address_name + '">' + place.address_name + '</span>';
            }                       
            content += '    <span class="tel">' + place.phone + '</span>' + 
                         '</div>' + 
                         '<div class="after"></div>';
            contentNode.innerHTML = content;
            placeOverlay.setPosition(new kakao.maps.LatLng(place.y, place.x));
            placeOverlay.setMap(map);  
        }

        // 각 카테고리에 클릭 이벤트를 등록합니다.
        function addCategoryClickEvent() {
            var category = document.getElementById('category'),
                children = category.children;
            for (var i=0; i<children.length; i++) {
                children[i].onclick = onClickCategory;
            }
        }

        // 카테고리를 클릭했을 때 호출되는 함수입니다
        function onClickCategory() {
            var id = this.id,
                className = this.className;
            placeOverlay.setMap(null);
            
            // 기존 Transit 마커 제거
            markers.forEach(m => m.setMap(null)); markers = []; 
            if (window.polyline) window.polyline.setMap(null); // Transit 경로 제거

            if (className === 'on') {
                currCategory = '';
                changeCategoryClass();
                removeCategoryMarker();
            } else {
                currCategory = id;
                changeCategoryClass(this);
                searchPlaces();
            }
        }

        // 클릭된 카테고리에만 클릭된 스타일을 적용하는 함수입니다
        function changeCategoryClass(el) {
            var category = document.getElementById('category'),
                children = category.children,
                i;
            for ( i=0; i<children.length; i++ ) {
                children[i].className = '';
            }
            if (el) {
                el.className = 'on';
            } 
        } 


        // *** 4. 실시간 검색 추천 기능 (기존 로직) ***
        
        /* 실시간 장소 검색 요청 및 결과 표시 함수 */
        function searchPlace(inputElement, resultContainer) {
            const keyword = inputElement.value.trim();
            if (keyword.length < 2) {
                resultContainer.style.display = 'none';
                return;
            }
            ps.keywordSearch(keyword, (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    renderResults(data, inputElement, resultContainer);
                } else {
                    resultContainer.style.display = 'none';
                }
            }, { size: 5 }); 
        }

        /* 검색 결과를 HTML 목록으로 변환하여 화면에 표시하는 함수 */
        function renderResults(places, inputElement, resultContainer) {
            let html = '<ul>';
            places.forEach(place => {
                const onClick = `selectResult('${inputElement.id}', '${place.place_name.replace(/'/g, "\\'")}', '${resultContainer.id}')`;
                html += `<li onclick="${onClick}">
                            ${place.place_name}
                            <span class="search-address">${place.address_name || place.road_address_name}</span>
                         </li>`;
            });
            html += '</ul>';
            resultContainer.innerHTML = html;
            
            // 결과창 위치 계산
            const inputRect = inputElement.getBoundingClientRect();
            const sheetRect = bottomSheet.getBoundingClientRect();
            resultContainer.style.width = `${inputRect.width}px`;
            resultContainer.style.top = `${inputRect.bottom - sheetRect.top}px`;
            resultContainer.style.left = `${inputRect.left - sheetRect.left}px`;
            resultContainer.style.display = 'block';
        }

        /* 목록을 클릭했을 때 Input 필드에 값을 넣고 목록을 숨기는 함수 */
        function selectResult(inputId, placeName, resultContainerId) {
            document.getElementById(inputId).value = placeName;
            document.getElementById(resultContainerId).style.display = 'none';
            document.getElementById(inputId).focus(); 
            expandSheet();
        }


        // *** 5. TMAP Transit 경로 검색 로직 (기존 로직) ***

        async function fetchTmapDataAndRender(start, end) {
            const payload = {
                startX: start.x, startY: start.y,
                endX: end.x, endY: end.y
            };
            
            try {
                // Vercel 서버 호출
                const response = await fetch(myServerUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                
                const data = await response.json();
                if (data.error) { throw new Error(data.error); }
                
                // 기존 카테고리 마커 제거 및 장소 정보 숨김
                removeCategoryMarker();
                placeOverlay.setMap(null); 
                changeCategoryClass(); // 카테고리 스타일 해제

                renderRoutes(data.routes);
                
            } catch (error) {
                console.error('TMAP 경로 검색 실패:', error);
                resultsContainer.innerHTML = `<div style="color: red;">경로 검색 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        }
        
        async function runHybridSearch() {
            const startName = startInput.value.trim();
            const endName = endInput.value.trim();
            
            if (!startName || !endName) {
                alert('출발지와 도착지를 모두 입력해주세요.');
                return;
            }
            
            resultsContainer.innerHTML = '경로를 검색하는 중입니다...';
            expandSheet();
            
            try {
                const start = await geocode(startName);
                const end = await geocode(endName);
                await fetchTmapDataAndRender(start, end);
                
            } catch (error) {
                resultsContainer.innerHTML = `<div style="color: red;">좌표 변환 또는 검색 실패: ${error.message}</div>`;
            }
        }
        
        function geocode(placeName) {
            return new Promise((resolve, reject) => {
                ps.keywordSearch(placeName, (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({ x: data[0].x, y: data[0].y, name: data[0].place_name });
                    } else {
                        reject(new Error(`${placeName}에 대한 정확한 장소를 찾을 수 없습니다.`));
                    }
                }, { size: 1 });
            });
        }
        
        function renderRoutes(routes) {
            // ... (경로 렌더링 로직은 그대로 유지) ...
        }
        
        function drawRoute(route) {
            // ... (경로 그리기 로직은 그대로 유지) ...
        }


        // *** 6. 통합 초기화 및 이벤트 연결 ***
        
        // 실시간 검색 이벤트 리스너 연결
        startInput.addEventListener('input', () => { searchPlace(startInput, startResults); });
        endInput.addEventListener('input', () => { searchPlace(endInput, endResults); });

        // 입력 필드 외 다른 곳 클릭 시 목록 숨김
        document.addEventListener('click', (e) => {
            if (!startInput.contains(e.target) && !startResults.contains(e.target)) { startResults.style.display = 'none'; }
            if (!endInput.contains(e.target) && !endResults.contains(e.target)) { endResults.style.display = 'none'; }
        });
        
        // 카테고리 필터 클릭 이벤트 등록
        addCategoryClickEvent(); 

    </script>
</body>
</html>
