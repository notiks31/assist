<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Map</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-frame">
    
    <div id="map"></div>

    <div class="top-center-btn">
        <button class="pill-btn" onclick="toggleAmenities()">
            <span>ğŸª</span> í¸ì˜ì  ì°¾ê¸°
        </button>
    </div>

    <div class="floating-menu" id="floatingMenu">
        
        <button class="menu-item" onclick="toggleTraffic()" title="êµí†µìƒí™©">
            ğŸš¦
        </button>
        
        <button class="menu-item" onclick="moveToCurrentLocation()" title="ë‚´ ìœ„ì¹˜">
            ğŸ“
        </button>
        
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24">
                <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
            </svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size: 18px;">ğŸ”</span>
                <span class="placeholder">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (í˜„ìœ„ì¹˜)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ ê²€ìƒ‰">
                </div>
                
                <div style="display:flex; gap:8px; margin:10px 0; overflow-x:auto;">
                    <button class="pill-btn" style="font-size:13px; padding:8px 14px;" onclick="fillSearch('í˜„ìœ„ì¹˜', 'ì§‘')">ğŸ  ì§‘ìœ¼ë¡œ</button>
                    <button class="pill-btn" style="font-size:13px; padding:8px 14px;" onclick="fillSearch('í˜„ìœ„ì¹˜', 'íšŒì‚¬')">ğŸ¢ íšŒì‚¬ë¡œ</button>
                </div>

                <button class="btn-search" onclick="findPath()">ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info">24ë¶„</div>
                    <button class="pill-btn" style="padding:6px 12px; font-size:12px;" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info">ì˜¤í›„ 1:30 ë„ì°© ì˜ˆì • â€¢ ë„ë³´ 5ë¶„</div>

                <div class="timeline">
                    <div class="t-item">
                        <div class="t-dot"></div>
                        <div class="t-text" id="resStart">ì¶œë°œì§€</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot" style="background:#eee; border:none; width:6px; height:6px; left:-17px;"></div>
                        <div class="t-text" style="color:#3182F6;">33ë²ˆ ë²„ìŠ¤ ì´ë™</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot end"></div>
                        <div class="t-text" id="resEnd">ë„ì°©ì§€</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* ì§€ë„ ì´ˆê¸°í™” */
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(37.566826, 126.9786567), level: 5 };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places();
    
    let markers = [];
    let polylines = [];
    let isTrafficOn = false;

    // ì‹œì‘ ì‹œ ë‚´ ìœ„ì¹˜ í‘œì‹œ
    window.onload = () => moveToCurrentLocation();

    /* [1] ë©”ë‰´ í† ê¸€ ë¡œì§ (ì• ë‹ˆë©”ì´ì…˜) */
    function toggleMenu() {
        const menu = document.getElementById('floatingMenu');
        menu.classList.toggle('open');
        // open í´ë˜ìŠ¤ê°€ ë¶™ìœ¼ë©´ CSSì—ì„œ ì•„ì´ì½˜ íšŒì „ ë° ë²„íŠ¼ íŒì—… ì²˜ë¦¬
    }

    /* [2] ë‚´ ìœ„ì¹˜ ì´ë™ */
    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                
                // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ (íŒŒë€ìƒ‰ í„ìŠ¤ ëŠë‚Œ)
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 4px 10px rgba(0,0,0,0.3);"></div>`;
                const overlay = new kakao.maps.CustomOverlay({ position: loc, content: content });
                overlay.setMap(map);
                map.panTo(loc);
            });
        }
    }

    /* [3] í¸ì˜ì  ì°¾ê¸° (ë‚´ ìœ„ì¹˜ ê¸°ì¤€) */
    function toggleAmenities() {
        markers.forEach(m => m.setMap(null)); markers = [];

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                map.setCenter(loc);

                // ë°˜ê²½ 1km í¸ì˜ì  ê²€ìƒ‰
                ps.categorySearch('CS2', (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        data.forEach(place => {
                            const marker = new kakao.maps.Marker({
                                map: map,
                                position: new kakao.maps.LatLng(place.y, place.x)
                            });
                            markers.push(marker);
                        });
                        alert(`ë‚´ ì£¼ë³€ í¸ì˜ì  ${data.length}ê³³ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!`);
                    } else {
                        alert('ì£¼ë³€ì— í¸ì˜ì ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }, { location: loc, radius: 1000 });
            });
        } else {
            alert("ìœ„ì¹˜ ì •ë³´ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.");
        }
    }

    /* êµí†µìƒí™© í† ê¸€ */
    function toggleTraffic() {
        if (isTrafficOn) {
            map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            isTrafficOn = false;
        } else {
            map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            isTrafficOn = true;
        }
    }

    /* [4] ê²½ë¡œ ê²€ìƒ‰ ê´€ë ¨ UI */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }

    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }

    async function findPath() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œ/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        const sCoord = await getCoords(sVal);
        const eCoord = await getCoords(eVal);
        
        if(sCoord && eCoord) {
            drawPath(sCoord, eCoord);
            searchForm.style.display = 'none';
            resultCard.classList.add('active');
            document.getElementById('resStart').innerText = sVal;
            document.getElementById('resEnd').innerText = eVal;
        }
    }

    function resetSearch() {
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    function getCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("í˜„ìœ„ì¹˜")) {
                navigator.geolocation.getCurrentPosition(pos => resolve(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) resolve(new kakao.maps.LatLng(data[0].y, data[0].x));
                    else resolve(null);
                });
            }
        });
    }

    function drawPath(s, e) {
        const mid = new kakao.maps.LatLng(s.getLat(), e.getLng());
        const path = [s, mid, e];
        const line = new kakao.maps.Polyline({
            path: path, strokeWeight: 6, strokeColor: '#3182F6', strokeOpacity: 0.9
        });
        line.setMap(map);
        polylines.push(line);
        
        const bounds = new kakao.maps.LatLngBounds();
        bounds.extend(s); bounds.extend(e); bounds.extend(mid);
        map.setBounds(bounds);
        
        new kakao.maps.Marker({map:map, position:s});
        new kakao.maps.Marker({map:map, position:e});
    }
</script>

</body>
</html>
