// TMAP 데이터 요청 -> 카카오 지도에 그리기
    async function fetchTmapDataAndRender(start, end) {
        // [수정됨] 버튼 승인이 필요 없는 'corsproxy.io' 서버 사용
        const proxy = 'https://corsproxy.io/?'; 
        const url = "https://apis.openapi.sk.com/transit/routes";
        
        const payload = {
            startX: start.lng, startY: start.lat,
            endX: end.lng, endY: end.lat,
            count: 1, format: "json"
        };

        // URL 인코딩 (필수)
        const targetUrl = proxy + encodeURIComponent(url);

        try {
            console.log("TMAP 요청 시작..."); 
            
            const response = await fetch(targetUrl, {
                method: "POST",
                headers: { 
                    "appKey": TMAP_APP_KEY, 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // 에러 발생 시 상세 내용 확인
                const errText = await response.text();
                console.error("TMAP API Error:", errText);
                throw new Error("API 호출 실패");
            }

            const data = await response.json();
            
            if (!data.metaData || !data.metaData.plan) {
                alert("대중교통 경로를 찾을 수 없습니다.");
                return;
            }

            const itinerary = data.metaData.plan.itineraries[0];
            
            // 정보 업데이트
            const totalTime = Math.round(itinerary.totalTime / 60);
            const totalFare = itinerary.fare.regular.totalFare;
            document.getElementById('totalTime').innerText = `${totalTime}분`;
            document.getElementById('routeSummary').innerText = `요금 ${totalFare}원 • 환승 ${itinerary.transferCount}회`;

            // 맵 초기화
            clearMapData();

            // 출발/도착 마커
            addMarker(start.lat, start.lng, 'start');
            addMarker(end.lat, end.lng, 'end');

            // 타임라인 생성
            const timelineBox = document.getElementById('routeTimeline');
            timelineBox.innerHTML = '';
            addTimelineItem(timelineBox, 'walk', '출발', start.name);

            // 경로 그리기
            const legs = itinerary.legs;
            const bounds = new kakao.maps.LatLngBounds(); 
            let hasPath = false;

            legs.forEach(leg => {
                if (leg.passShape) {
                    const path = parseTmapShapeToKakao(leg.passShape);
                    if (path.length > 0) {
                        hasPath = true;
                        
                        const color = leg.mode === 'WALK' ? '#8B95A1' : '#3182F6';
                        const style = leg.mode === 'WALK' ? 'shortdash' : 'solid';
                        const weight = leg.mode === 'WALK' ? 5 : 7; 

                        const polyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: weight, strokeColor: color,
                            strokeOpacity: 0.9, strokeStyle: style
                        });
                        polyline.setMap(map);
                        polylines.push(polyline);
                        
                        // Bounds 최적화 (시작/끝점만 추가)
                        bounds.extend(path[0]);
                        bounds.extend(path[path.length-1]);
                    }
                }

                if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'bus', `${leg.route} 승차`, `${time}분 이동`);
                } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'walk', `도보 이동`, `${time}분`);
                }
            });

            addTimelineItem(timelineBox, 'walk', '도착', end.name);
            
            // 지도 깨짐 방지
            map.relayout();
            if(hasPath && !bounds.isEmpty()) {
                setTimeout(() => map.setBounds(bounds), 200);
            }

        } catch (e) {
            console.error(e);
            alert("경로를 불러올 수 없습니다. (콘솔 확인 필요)");
        }
    }
