<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>All TMAP</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti"></script>
</head>
<body>

<div class="app-frame">
    <div id="map_div"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()" title="êµí†µìƒí™©">ğŸš¦</button>
        <button class="menu-item" onclick="moveToCurrentLocation()" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size: 18px;">ğŸ”</span>
                <span class="placeholder">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (ì˜ˆ: ì„œìš¸ì—­)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ (ì˜ˆ: ê°•ë‚¨ì—­)">
                </div>
                <div style="display:flex; gap:8px; margin:10px 0; overflow-x:auto;">
                    <button class="pill-btn" onclick="fillSearch('ì„œìš¸ì—­', 'ë¡¯ë°ì›”ë“œ')">ğŸ¡ ë†€ëŸ¬ê°€ê¸°</button>
                    <button class="pill-btn" onclick="fillSearch('ê°•ë‚¨ì—­', 'í™ëŒ€ì…êµ¬')">ğŸš‡ ì§€í•˜ì² </button>
                </div>
                <button class="btn-search" onclick="searchAndRoute()">TMAP ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="totalTime">00ë¶„</div>
                    <button class="pill-btn" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info" id="routeSummary">ê²½ë¡œ ê³„ì‚° ì¤‘...</div>

                <div class="timeline" id="routeTimeline"></div>
            </div>
        </div>
    </div>
</div>

<script>
    /* -------------------------------------------
       [1] ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
       ------------------------------------------- */
    // ì‚¬ìš©ìë‹˜ì´ ì œê³µí•œ TMAP KEY
    const APP_KEY = "vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti";
    
    let map;
    let markerList = [];
    let lineList = [];
    let isTrafficOn = false;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ TMAP ì´ˆê¸°í™”
    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.566481622437934, 126.98502302169841), // ì´ˆê¸° ì„œìš¸ ì¤‘ì‹¬
            width: "100%",
            height: "100%",
            zoom: 14,
            zoomControl: false,
            scrollwheel: true
        });
        
        // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ ì‹œë„
        moveToCurrentLocation();
    }

    window.onload = initTmap;

    /* -------------------------------------------
       [2] UI ë¡œì§
       ------------------------------------------- */
    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const loc = new Tmapv2.LatLng(lat, lon);
                    
                    map.setCenter(loc);
                    
                    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ (ì»¤ìŠ¤í…€ HTML ë§ˆì»¤ëŠ” TMAPì—ì„œ ë³µì¡í•˜ë¯€ë¡œ ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš©)
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
                    removeMarkers();
                    const marker = new Tmapv2.Marker({
                        position: loc,
                        map: map,
                        title: "ë‚´ ìœ„ì¹˜"
                    });
                    markerList.push(marker);
                },
                (error) => { console.error("ìœ„ì¹˜ ê¶Œí•œ ì˜¤ë¥˜", error); }
            );
        }
    }

    function toggleTraffic() {
        // TMAP JS APIëŠ” êµí†µì •ë³´ ë ˆì´ì–´ í† ê¸€ ê¸°ëŠ¥ì´ ì œí•œì ì´ë¼ ì˜ˆì™¸ ì²˜ë¦¬
        alert("TMAP JS APIì—ì„œëŠ” êµí†µì •ë³´ ë ˆì´ì–´ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
    }

    /* -------------------------------------------
       [3] ì‹œíŠ¸ ì—´ê³  ë‹«ê¸°
       ------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        removeLines();
        removeMarkers();
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    /* -------------------------------------------
       [4] TMAP ì¥ì†Œ ê²€ìƒ‰ (POI Search)
       ------------------------------------------- */
    async function searchAndRoute() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        try {
            // 1. ì¶œë°œì§€ ì¢Œí‘œ êµ¬í•˜ê¸°
            const startPOI = await getPoiLocation(sVal);
            if(!startPOI) return alert("ì¶œë°œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 2. ë„ì°©ì§€ ì¢Œí‘œ êµ¬í•˜ê¸°
            const endPOI = await getPoiLocation(eVal);
            if(!endPOI) return alert("ë„ì°©ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 3. ëŒ€ì¤‘êµí†µ ê²½ë¡œ íƒìƒ‰
            await findTransitRoute(startPOI, endPOI);

            // 4. UI ì „í™˜
            searchForm.style.display = 'none';
            resultCard.classList.add('active');

        } catch (error) {
            console.error(error);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // TMAP POI ê²€ìƒ‰ API í˜¸ì¶œ
    async function getPoiLocation(keyword) {
        const url = `https://apis.openapi.sk.com/tmap/pois?version=1&searchKeyword=${encodeURIComponent(keyword)}&resCoordType=WGS84GEO&reqCoordType=WGS84GEO&count=1&appKey=${APP_KEY}`;
        
        const res = await fetch(url);
        const data = await res.json();

        if(data.searchPoiInfo && data.searchPoiInfo.pois.poi.length > 0) {
            const poi = data.searchPoiInfo.pois.poi[0];
            return {
                lat: poi.noorLat,
                lon: poi.noorLon,
                name: poi.name
            };
        }
        return null;
    }

    /* -------------------------------------------
       [5] TMAP ëŒ€ì¤‘êµí†µ ê²½ë¡œ (Transit Route)
       ------------------------------------------- */
    async function findTransitRoute(start, end) {
        const url = "https://apis.openapi.sk.com/transit/routes";
        const payload = {
            startX: start.lon,
            startY: start.lat,
            endX: end.lon,
            endY: end.lat,
            count: 1,
            format: "json"
        };

        const res = await fetch(url, {
            method: "POST",
            headers: {
                "appKey": APP_KEY,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        
        if(!data.metaData || !data.metaData.plan) {
            return alert("ëŒ€ì¤‘êµí†µ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const itinerary = data.metaData.plan.itineraries[0];
        
        // ì •ë³´ ì—…ë°ì´íŠ¸
        const totalTime = Math.round(itinerary.totalTime / 60);
        const fare = itinerary.fare.regular.totalFare;
        document.getElementById('totalTime').innerText = `${totalTime}ë¶„`;
        document.getElementById('routeSummary').innerText = `ìš”ê¸ˆ ${fare}ì› â€¢ í™˜ìŠ¹ ${itinerary.transferCount}íšŒ`;

        // ë§µ ì´ˆê¸°í™”
        removeLines();
        removeMarkers();

        // ë§ˆì»¤ ìƒì„±
        addMarker(start.lat, start.lon, "ì¶œë°œ");
        addMarker(end.lat, end.lon, "ë„ì°©");

        // íƒ€ì„ë¼ì¸ ê·¸ë¦¬ê¸° ì¤€ë¹„
        const timelineBox = document.getElementById('routeTimeline');
        timelineBox.innerHTML = '';
        
        addTimelineItem(timelineBox, 'start', start.name);

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        const legs = itinerary.legs;
        const bounds = new Tmapv2.LatLngBounds();

        legs.forEach(leg => {
            // 1. ì§€ë„ì— ì„  ê·¸ë¦¬ê¸°
            if (leg.passShape) {
                const path = parsePassShape(leg.passShape);
                const color = leg.mode === 'WALK' ? '#8B95A1' : '#E60023'; // ë„ë³´:íšŒìƒ‰, ë²„ìŠ¤:ë ˆë“œ(TMAPìƒ‰)
                const style = leg.mode === 'WALK' ? 'dot' : 'solid';
                
                const polyline = new Tmapv2.Polyline({
                    path: path,
                    strokeColor: color,
                    strokeWeight: 6,
                    style: style,
                    map: map
                });
                lineList.push(polyline);
                
                path.forEach(pt => bounds.extend(pt));
            }

            // 2. íƒ€ì„ë¼ì¸ ì¶”ê°€
            if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'transit', `${leg.route} ìŠ¹ì°¨`, `${time}ë¶„ ì´ë™`);
            } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'walk', `ë„ë³´ ì´ë™`, `${time}ë¶„`);
            }
        });

        addTimelineItem(timelineBox, 'end', end.name);
        map.fitBounds(bounds);
    }

    // ì¢Œí‘œ íŒŒì‹±
    function parsePassShape(passShape) {
        const path = [];
        const coords = passShape.split(' ');
        coords.forEach(c => {
            const [lon, lat] = c.split(',');
            path.push(new Tmapv2.LatLng(lat, lon));
        });
        return path;
    }

    // ë§ˆì»¤ ì¶”ê°€
    function addMarker(lat, lon, title) {
        const marker = new Tmapv2.Marker({
            position: new Tmapv2.LatLng(lat, lon),
            map: map,
            title: title
        });
        markerList.push(marker);
    }

    // íƒ€ì„ë¼ì¸ ì•„ì´í…œ UI
    function addTimelineItem(container, type, title, desc = "") {
        let dotClass = 't-dot';
        let colorStyle = '';
        
        if (type === 'end') dotClass = 't-dot end';
        else if (type === 'transit') {
            colorStyle = 'color:#E60023;'; // TMAP Red
        }

        const html = `
            <div class="t-item">
                <div class="${dotClass}" ${type==='transit' ? 'style="background:#f2f4f6; border:none; width:6px; height:6px; left:-17px;"' : ''}></div>
                <div class="t-text" style="${colorStyle}">${title}</div>
                <div class="t-sub">${desc}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // ì •ë¦¬ í•¨ìˆ˜
    function removeMarkers() {
        markerList.forEach(m => m.setMap(null));
        markerList = [];
    }
    function removeLines() {
        lineList.forEach(l => l.setMap(null));
        lineList = [];
    }

</script>

</body>
</html>
