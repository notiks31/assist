<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í™˜ìŠ¹ ì–´ì‹œìŠ¤íŠ¸ (Transfer Assist)</title>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-container">
    <div class="top-map-area">
        <div id="map" style="width:100%; height:100%;"></div>

        <div class="map-badge" id="map-status-text">ğŸ“ ë‚´ ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...</div>

        <button class="bus-test-btn" onclick="simulateRealTimeBus()">ğŸšŒ ë²„ìŠ¤ ë³´ê¸° (ì‹¤ì‹œê°„)</button>
    </div>

    <div class="bottom-content-area">

        <div id="step-1" class="screen active">
            <div class="content-header">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</div>
            
            <div class="input-group">
                <div class="input-box">
                    <span>ğŸ”µ</span> 
                    <input type="text" id="start-input" placeholder="ì¶œë°œì§€ ê²€ìƒ‰" onkeyup="filterPlaces('start-input', 'start-list')">
                </div>
                <div id="start-list" class="suggestion-list"></div>
            </div>

            <div class="input-group">
                <div class="input-box">
                    <span>ğŸ”´</span> 
                    <input type="text" id="end-input" placeholder="ë„ì°©ì§€ ê²€ìƒ‰" onkeyup="filterPlaces('end-input', 'end-list')">
                </div>
                <div id="end-list" class="suggestion-list"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="font-size:12px; color:#888; margin-bottom:10px;">ì¦ê²¨ì°¾ê¸°</div>
                
                <div class="favorite-box">
                    <div style="flex:1;" onclick="useFavorite()">
                        <span>â­</span> 
                        <span id="fav-title" style="font-weight:bold; margin-left:5px;">ì§‘ â†’ í•™êµ</span><br>
                        <span id="fav-desc" style="font-size:11px; color:#aaa; margin-left:25px;">33ë²ˆ ë²„ìŠ¤ ì´ìš©</span>
                    </div>
                    <div class="favorite-edit-btn" onclick="editFavorite(event)">âš™ï¸</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="goToStep(2)">ê²½ë¡œ ì°¾ê¸°</button>
        </div>

        <div id="step-2" class="screen">
            <div class="content-header">
                <span>ì¶”ì²œ ê²½ë¡œ</span>
                <span style="font-size:14px; color:var(--primary);">24ë¶„ ì†Œìš”</span>
            </div>

            <div class="timeline-container">
                <div class="timeline-left">
                    <span class="timeline-time">12:36</span>
                    <div class="timeline-dot active"></div>
                    <div class="timeline-line active"></div>
                </div>
                <div class="timeline-right">
                    <div class="location-title" id="route-start-text">ì¶œë°œì§€</div>
                </div>

                <div class="timeline-left">
                    <div class="timeline-line active"></div>
                    <span class="timeline-icon">ğŸš¶</span>
                </div>
                <div class="timeline-right">
                    <div class="location-title">ë„ë³´ 1ë¶„</div>
                </div>

                <div class="timeline-left">
                    <span class="timeline-time">12:42</span>
                    <div class="timeline-dot active"></div>
                    <div class="timeline-line active"></div>
                </div>
                <div class="timeline-right">
                    <div class="location-title">ì •ë¥˜ì¥ ë„ì°©</div>
                     <div class="bus-info-box" onclick="goToStep(3)">
                        <div style="margin-bottom:5px;">
                            <span class="bus-tag">ê³§ ë„ì°©</span>
                            <span style="color:var(--primary); font-weight:bold;">33ë²ˆ</span>
                        </div>
                        <div class="location-desc">
                            âŒ„ 5ë¶„ (ì •ë¥˜ì¥ 4ê°œ) ì´ë™<br>
                            ê°œê¸ˆì—­ ê²½ìœ 
                        </div>
                    </div>
                </div>

                <div class="timeline-left">
                     <span class="timeline-icon">ğŸšŒ</span>
                </div>
                <div class="timeline-right">
                    <div class="location-title">ë²„ìŠ¤ ì´ë™ ì¤‘</div>
                </div>

                 <div class="timeline-left">
                    <div class="timeline-dot"></div>
                </div>
                <div class="timeline-right">
                    <div class="location-title" id="route-end-text">ë„ì°©ì§€</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="goToStep(3)">ì•ˆë‚´ ì‹œì‘</button>
            <button class="btn btn-outline" onclick="goToStep(1)">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <div id="step-3" class="screen">
            <div class="content-header">ë²„ìŠ¤ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘</div>
            <div class="bus-info-box" style="text-align:center; background:white; border:2px solid var(--primary);">
                <div style="font-size:14px;">33ë²ˆ ë²„ìŠ¤</div>
                <div style="font-size:32px; font-weight:bold; color:var(--danger); margin:10px 0;">3ë¶„ 20ì´ˆ</div>
                <div style="color:#888;">ì ì‹œ í›„ ë„ì°©í•©ë‹ˆë‹¤</div>
            </div>
            <button class="btn btn-primary" onclick="goToStep(4)">ë²„ìŠ¤ íƒ‘ìŠ¹ ì™„ë£Œ</button>
        </div>

        <div id="step-4" class="screen">
            <div class="content-header">ì´ë™ ì¤‘...</div>
            <button class="btn btn-warning" onclick="goToStep(5)">ğŸ”” í•˜ì°¨ ë²¨ ëˆ„ë¥´ê¸°</button>
        </div>
        
        <div id="step-5" class="screen">
            <div style="text-align:center;">
                <h2>ë„ì°©!</h2>
                <button class="btn btn-primary" onclick="goToStep(1)">ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>

    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df"></script>

<script>
    /* =========================================
       [ê¸°ëŠ¥ 1] ì§€ë„ ë° ë‚´ ìœ„ì¹˜ ì„¤ì •
       ========================================= */
    var mapContainer = document.getElementById('map');
    var mapOption = { 
        center: new kakao.maps.LatLng(35.1512, 129.0123), // ê¸°ë³¸: ë¶€ì‚° ëƒ‰ì •ì—­
        level: 5 
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    
    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
    var myMarker = new kakao.maps.Marker({
        position: map.getCenter(), 
        map: null 
    });

    // ë¸Œë¼ìš°ì € GPS ì‚¬ìš©
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            var locPosition = new kakao.maps.LatLng(lat, lon);

            map.setCenter(locPosition);
            myMarker.setPosition(locPosition);
            myMarker.setMap(map);
            
            document.getElementById('map-status-text').innerText = "ğŸ“ í˜„ì¬ ë‚´ ìœ„ì¹˜";
        });
    }

    /* =========================================
       [ê¸°ëŠ¥ 2] ì‹¤ì œ ë²„ìŠ¤ API ì—°ë™ (CORS ìš°íšŒ)
       ========================================= */
    var busMarkers = []; // ë²„ìŠ¤ ë§ˆì»¤ ê´€ë¦¬ìš© ë°°ì—´

    async function getRealBusData() {
        const statusText = document.getElementById('map-status-text');
        
        // âš ï¸ ì—¬ê¸°ì— ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ ë°›ì€ [Decoding ì¸ì¦í‚¤]ë¥¼ ê¼­ ë„£ìœ¼ì„¸ìš”!
        const serviceKey = '1fe0be0bcba2e3e38d12218b55ae1e841ae702d4290b2b21c9926f38d7c34c1b'; 
        
        // ë¶€ì‚° 33ë²ˆ ë²„ìŠ¤ ë…¸ì„  ID
        const lineId = '5200033000'; 
        
        // CORS ìš°íšŒ ì„œë²„ (ë°˜ë“œì‹œ ë°ëª¨ ì¸ì¦ í•„ìš”)
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const apiUrl = `http://apis.data.go.kr/6260000/BusanBims/busInfoByRouteId?serviceKey=${serviceKey}&lineId=${lineId}&numOfRows=10&pageNo=1`;

        try {
            statusText.innerText = "ğŸ“¡ ë°ì´í„° ìˆ˜ì‹  ì¤‘...";
            const response = await fetch(proxyUrl + apiUrl);
            
            if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");

            const str = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(str, "text/xml");

            // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
            removeBusMarkers();

            const items = xmlDoc.getElementsByTagName("item");
            if (items.length === 0) {
                statusText.innerText = "âš ï¸ ìš´í–‰ ë²„ìŠ¤ ì—†ìŒ";
                alert("ìš´í–‰ ì¤‘ì¸ ë²„ìŠ¤ê°€ ì—†ê±°ë‚˜ ì¸ì¦í‚¤ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
                return;
            }

            // ì§€ë„ì— ë²„ìŠ¤ í‘œì‹œ
            for (let i = 0; i < items.length; i++) {
                const lat = items[i].getElementsByTagName("lat")[0].textContent;
                const lng = items[i].getElementsByTagName("lng")[0].textContent;
                const carNo = items[i].getElementsByTagName("carNo")[0].textContent;

                var busPos = new kakao.maps.LatLng(lat, lng);
                var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/busStop.png', 
                    imageSize = new kakao.maps.Size(24, 35); 
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                var marker = new kakao.maps.Marker({
                    position: busPos,
                    image: markerImage,
                    map: map,
                    title: carNo
                });

                busMarkers.push(marker);
            }

            statusText.innerText = `ğŸšŒ ${items.length}ëŒ€ ìš´í–‰ ì¤‘ (ì‹¤ì‹œê°„)`;
            
            // ì²« ë²ˆì§¸ ë²„ìŠ¤ ìœ„ì¹˜ë¡œ ì´ë™
            if(items.length > 0) {
                const firstLat = items[0].getElementsByTagName("lat")[0].textContent;
                const firstLng = items[0].getElementsByTagName("lng")[0].textContent;
                map.panTo(new kakao.maps.LatLng(firstLat, firstLng));
            }

        } catch (error) {
            console.error(error);
            statusText.innerText = "âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
            alert("1. ê³µê³µë°ì´í„° ì¸ì¦í‚¤ í™•ì¸\n2. cors-anywhere ì‚¬ì´íŠ¸ ë°ëª¨ ë²„íŠ¼ í´ë¦­ í™•ì¸");
        }
    }

    function removeBusMarkers() {
        for (var i = 0; i < busMarkers.length; i++) {
            busMarkers[i].setMap(null);
        }
        busMarkers = [];
    }

    /* =========================================
       [ê¸°ëŠ¥ 3] ì¦ê²¨ì°¾ê¸° ë° UI ë¡œì§
       ========================================= */
    let favoriteData = { title: "ì§‘ â†’ í•™êµ", desc: "33ë²ˆ ë²„ìŠ¤ ì´ìš©", start: "ì§‘", end: "í•™êµ" };

    function useFavorite() {
        document.getElementById('start-input').value = favoriteData.start;
        document.getElementById('end-input').value = favoriteData.end;
        alert(`'${favoriteData.title}' ê²½ë¡œ ì„¤ì •ë¨`);
    }

    function editFavorite(event) {
        event.stopPropagation();
        const newTitle = prompt("ì¦ê²¨ì°¾ê¸° ì´ë¦„:", favoriteData.title);
        if(!newTitle) return;
        const newDesc = prompt("ì„¤ëª…:", favoriteData.desc);
        
        favoriteData.title = newTitle;
        if(newDesc) favoriteData.desc = newDesc;

        document.getElementById('fav-title').innerText = favoriteData.title;
        document.getElementById('fav-desc').innerText = favoriteData.desc;
    }

    function simulateRealTimeBus() {
        // [ë²„ìŠ¤ ë³´ê¸°] ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
        getRealBusData();
    }

    function goToStep(stepNumber) {
        if(stepNumber === 2) {
             const startVal = document.getElementById('start-input').value;
             const endVal = document.getElementById('end-input').value;
             document.getElementById('route-start-text').textContent = startVal || "ì¶œë°œì§€";
             document.getElementById('route-end-text').textContent = endVal || "ë„ì°©ì§€";
        }
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        const targetScreen = document.getElementById(`step-${stepNumber}`);
        if(targetScreen) targetScreen.classList.add('active');
    }

    const mockPlaces = ["ëƒ‰ì •ì—­ 2í˜¸ì„ ", "ì„œë©´ì—­ 1í˜¸ì„ ", "ë¶€ì‚°ì—­", "ë™ì˜ëŒ€", "ê°€ì•¼ê³µì›"];
    function filterPlaces(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        const filter = input.value;
        if (!filter) { list.style.display = 'none'; return; }
        
        list.innerHTML = "";
        mockPlaces.filter(p => p.includes(filter)).forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerText = item;
            div.onclick = () => { input.value = item; list.style.display = 'none'; };
            list.appendChild(div);
        });
        list.style.display = 'block';
    }
</script>

</body>
</html>
