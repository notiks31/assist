<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TMAP Transit Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti"></script>
</head>
<body>

<div class="app-frame">
    <div id="map_div"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()" title="êµí†µìƒí™©">ğŸš¦</button>
        <button class="menu-item" onclick="moveToCurrentLocation()" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size: 18px;">ğŸ”</span>
                <span class="placeholder">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (ì˜ˆ: ì„œìš¸ì—­)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ (ì˜ˆ: ê°•ë‚¨ì—­)">
                </div>
                <div style="display:flex; gap:8px; margin:10px 0; overflow-x:auto;">
                    <button class="pill-btn" onclick="fillSearch('ì„œìš¸ì—­', 'ë¡¯ë°ì›”ë“œ')">ğŸ¡ ë†€ëŸ¬ê°€ê¸°</button>
                    <button class="pill-btn" onclick="fillSearch('ê°•ë‚¨ì—­', 'í™ëŒ€ì…êµ¬')">ğŸš‡ ì§€í•˜ì² </button>
                </div>
                <button class="btn-search" onclick="searchAndRoute()">TMAP ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="totalTime">00ë¶„</div>
                    <button class="pill-btn" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info" id="routeSummary">ê²½ë¡œ ê³„ì‚° ì¤‘...</div>

                <div class="timeline" id="routeTimeline"></div>
            </div>
        </div>
    </div>
</div>

<script>
    /* -------------------------------------------
       [1] ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
       ------------------------------------------- */
    const APP_KEY = "vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti"; // TMAP API í‚¤
    
    let map;
    let markerList = [];
    let lineList = [];
    let isTrafficOn = false;

    // TMAP ì§€ë„ ë„ìš°ê¸°
    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.566481622437934, 126.98502302169841),
            width: "100%",
            height: "100%",
            zoom: 14,
            zoomControl: false,
            scrollwheel: true
        });
        moveToCurrentLocation();
    }

    window.onload = initTmap;

    /* -------------------------------------------
       [2] UI ë¡œì§
       ------------------------------------------- */
    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const loc = new Tmapv2.LatLng(lat, lon);
                    map.setCenter(loc);
                    removeMarkers();
                    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
                    const marker = new Tmapv2.Marker({
                        position: loc,
                        map: map,
                        icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png", // TMAP ê¸°ë³¸ ë§ˆì»¤
                        title: "ë‚´ ìœ„ì¹˜"
                    });
                    markerList.push(marker);
                },
                (error) => console.error("ìœ„ì¹˜ ì˜¤ë¥˜", error)
            );
        }
    }

    function toggleTraffic() {
        alert("êµí†µì •ë³´ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
    }

    /* -------------------------------------------
       [3] ì‹œíŠ¸ ë¡œì§
       ------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        removeLines();
        removeMarkers();
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    /* -------------------------------------------
       [4] TMAP ì¥ì†Œ ê²€ìƒ‰ & ê¸¸ì°¾ê¸° (í•µì‹¬ ìˆ˜ì •ë¨)
       ------------------------------------------- */
    async function searchAndRoute() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

        try {
            // 1. ì¶œë°œì§€ ì¢Œí‘œ ê²€ìƒ‰
            const startPOI = await getPoiLocation(sVal);
            if(!startPOI) return alert("ì¶œë°œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 2. ë„ì°©ì§€ ì¢Œí‘œ ê²€ìƒ‰
            const endPOI = await getPoiLocation(eVal);
            if(!endPOI) return alert("ë„ì°©ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 3. ê¸¸ì°¾ê¸° ì‹¤í–‰
            await findTransitRoute(startPOI, endPOI);

            // 4. í™”ë©´ ì „í™˜
            searchForm.style.display = 'none';
            resultCard.classList.add('active');

        } catch (error) {
            console.error(error);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. F12 ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
    }

    // POI ê²€ìƒ‰ (Proxy ì ìš©)
    async function getPoiLocation(keyword) {
        // ìš°íšŒ ì„œë²„(allorigins) ì‚¬ìš©
        const proxy = 'https://api.allorigins.win/raw?url=';
        const tmapUrl = `https://apis.openapi.sk.com/tmap/pois?version=1&searchKeyword=${encodeURIComponent(keyword)}&resCoordType=WGS84GEO&reqCoordType=WGS84GEO&count=1&appKey=${APP_KEY}`;
        
        // Proxy + TMAP URL ê²°í•©
        const res = await fetch(proxy + encodeURIComponent(tmapUrl));
        const data = await res.json();

        if(data.searchPoiInfo && data.searchPoiInfo.pois.poi.length > 0) {
            const poi = data.searchPoiInfo.pois.poi[0];
            return { lat: poi.noorLat, lon: poi.noorLon, name: poi.name };
        }
        return null;
    }

    // ëŒ€ì¤‘êµí†µ ê¸¸ì°¾ê¸° (Proxy ì ìš©)
    async function findTransitRoute(start, end) {
        const proxy = 'https://api.allorigins.win/raw?url=';
        const tmapUrl = "https://apis.openapi.sk.com/transit/routes";
        
        const payload = {
            startX: start.lon,
            startY: start.lat,
            endX: end.lon,
            endY: end.lat,
            count: 1,
            format: "json"
        };

        const res = await fetch(proxy + encodeURIComponent(tmapUrl), {
            method: "POST",
            headers: {
                "appKey": APP_KEY,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errText = await res.text();
            console.error("API Error Response:", errText); // ì—ëŸ¬ ë‚´ìš© ì½˜ì†” ì¶œë ¥
            throw new Error("TMAP API ìš”ì²­ ì‹¤íŒ¨");
        }

        const data = await res.json();
        
        if(!data.metaData || !data.metaData.plan) {
            alert("ëŒ€ì¤‘êµí†µ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤. (ë„ˆë¬´ ê°€ê¹ê±°ë‚˜ ë¨¼ ê±°ë¦¬)");
            return;
        }

        const itinerary = data.metaData.plan.itineraries[0];
        
        // ì •ë³´ í‘œì‹œ
        const totalTime = Math.round(itinerary.totalTime / 60);
        const fare = itinerary.fare.regular.totalFare;
        document.getElementById('totalTime').innerText = `${totalTime}ë¶„`;
        document.getElementById('routeSummary').innerText = `ìš”ê¸ˆ ${fare}ì› â€¢ í™˜ìŠ¹ ${itinerary.transferCount}íšŒ`;

        // ë§µ ì •ë¦¬
        removeLines();
        removeMarkers();

        // ë§ˆì»¤
        addMarker(start.lat, start.lon, "ì¶œë°œ");
        addMarker(end.lat, end.lon, "ë„ì°©");

        // íƒ€ì„ë¼ì¸ ê·¸ë¦¬ê¸°
        const timelineBox = document.getElementById('routeTimeline');
        timelineBox.innerHTML = '';
        addTimelineItem(timelineBox, 'start', start.name);

        const legs = itinerary.legs;
        const bounds = new Tmapv2.LatLngBounds();

        legs.forEach(leg => {
            // ì„  ê·¸ë¦¬ê¸°
            if (leg.passShape) {
                const path = parsePassShape(leg.passShape);
                const color = leg.mode === 'WALK' ? '#8B95A1' : '#E60023'; // ë„ë³´ íšŒìƒ‰, íƒ‘ìŠ¹ ë¹¨ê°•
                const style = leg.mode === 'WALK' ? 'dot' : 'solid';
                
                const polyline = new Tmapv2.Polyline({
                    path: path,
                    strokeColor: color,
                    strokeWeight: 6,
                    style: style,
                    map: map
                });
                lineList.push(polyline);
                path.forEach(pt => bounds.extend(pt));
            }

            // íƒ€ì„ë¼ì¸
            if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'transit', `${leg.route} ìŠ¹ì°¨`, `${time}ë¶„ ì´ë™`);
            } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                const time = Math.round(leg.sectionTime / 60);
                addTimelineItem(timelineBox, 'walk', `ë„ë³´ ì´ë™`, `${time}ë¶„`);
            }
        });

        addTimelineItem(timelineBox, 'end', end.name);
        map.fitBounds(bounds);
    }

    /* -------------------------------------------
       [5] ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
       ------------------------------------------- */
    function parsePassShape(passShape) {
        const path = [];
        const coords = passShape.split(' ');
        coords.forEach(c => {
            const [lon, lat] = c.split(',');
            path.push(new Tmapv2.LatLng(lat, lon));
        });
        return path;
    }

    function addMarker(lat, lon, title) {
        const marker = new Tmapv2.Marker({
            position: new Tmapv2.LatLng(lat, lon),
            map: map,
            title: title
        });
        markerList.push(marker);
    }

    function removeMarkers() {
        markerList.forEach(m => m.setMap(null));
        markerList = [];
    }
    function removeLines() {
        lineList.forEach(l => l.setMap(null));
        lineList = [];
    }

    function addTimelineItem(container, type, title, desc = "") {
        let dotClass = 't-dot walk';
        let colorStyle = '';
        if (type === 'end') dotClass = 't-dot end';
        else if (type === 'transit') {
            colorStyle = 'color:#E60023;'; 
            dotClass = 't-dot bus';
        }

        const html = `
            <div class="t-item">
                <div class="${dotClass}" ${type==='transit' ? 'style="background:#f2f4f6; border:none; width:6px; height:6px; left:-17px;"' : ''}></div>
                <div class="t-text" style="${colorStyle}">${title}</div>
                <div class="t-sub">${desc}</div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
</script>

</body>
</html>
