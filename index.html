<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hybrid Transit Pro (Server)</title>
    <style>
        /* -------------------------------------------
           [Ïä§ÌÉÄÏùº Ï†ïÏùò]
           ------------------------------------------- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #f5f6f8; }

        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }

        /* ÌîåÎ°úÌåÖ Î©îÎâ¥ */
        .floating-menu {
            position: absolute; top: 16px; right: 16px; z-index: 10;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .menu-item {
            width: 44px; height: 44px; border-radius: 50%; background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: none; font-size: 20px;
            display: none; align-items: center; justify-content: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .menu-item:active { transform: scale(0.95); }
        .floating-menu.open .menu-item { display: flex; }
        .toggle-btn {
            width: 44px; height: 44px; border-radius: 50%; background: #3182F6; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: none; display: flex;
            align-items: center; justify-content: center; cursor: pointer; z-index: 11;
        }
        .toggle-btn svg { width: 24px; height: 24px; fill: currentColor; transition: transform 0.3s; }
        .floating-menu.open .toggle-btn svg { transform: rotate(45deg); }

        /* Î∞îÌÖÄ ÏãúÌä∏ */
        .bottom-sheet {
            position: absolute; left: 0; right: 0; bottom: 0; background: white;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 20;
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .bottom-sheet.collapsed { height: 140px; }
        .bottom-sheet.expanded { height: 80%; }

        .sheet-header {
            width: 100%; height: 24px; display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; cursor: pointer; background: white;
        }
        .handle-bar { width: 40px; height: 5px; background: #E5E8EB; border-radius: 3px; }

        .sheet-content { flex: 1; padding: 0 20px 20px; overflow-y: auto; display: flex; flex-direction: column; }

        .search-bar {
            width: 100%; height: 50px; background: #F2F4F6; border-radius: 12px;
            display: flex; align-items: center; padding: 0 16px; gap: 10px; cursor: pointer; margin-bottom: 20px; flex-shrink: 0;
        }

        .search-form { display: block; }
        .input-row { position: relative; margin-bottom: 12px; }
        .input-text {
            width: 100%; height: 48px; border: 1px solid #E5E8EB; border-radius: 12px;
            padding: 0 16px 0 40px; font-size: 16px; outline: none; background: #fff;
        }
        .input-text:focus { border-color: #3182F6; }
        .dot { position: absolute; left: 14px; top: 18px; width: 8px; height: 8px; border-radius: 50%; }
        .dot.start { background: #191F28; }
        .dot.end { background: #FF3B30; }

        .btn-search {
            width: 100%; height: 52px; background: #3182F6; color: white; border: none;
            border-radius: 14px; font-size: 17px; font-weight: 700; cursor: pointer; margin-top: 10px;
        }
        .pill {
            padding: 6px 14px; background: #F2F4F6; border-radius: 20px; font-size: 13px;
            color: #4E5968; border: none; cursor: pointer; font-weight: 600;
        }

        .result-card { display: none; margin-top: 0; flex-direction: column; height: 100%; }
        .result-card.active { display: flex; }
        .time-info { font-size: 26px; font-weight: 800; color: #191F28; margin-bottom: 4px; }
        .sub-info { font-size: 15px; color: #8B95A1; margin-bottom: 20px; }

        .timeline {
            flex: 1; overflow-y: auto; padding-left: 10px; position: relative;
            border-left: 2px solid #E5E8EB; margin-left: 10px;
        }
        .t-item { position: relative; padding-left: 20px; margin-bottom: 24px; }
        .t-dot {
            position: absolute; left: -7px; top: 4px; width: 12px; height: 12px;
            border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px #fff;
        }
        .t-dot.walk { background: #8B95A1; }
        .t-dot.bus { background: #3182F6; }
        .t-text { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .t-sub { font-size: 13px; color: #8B95A1; }

    </style>
</head>
<body>

<div class="app-frame">
    <div id="map"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()">üö¶</button>
        <button class="menu-item" onclick="moveToCurrentLocation()">üìç</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size:18px">üîç</span>
                <span style="color:#adb5bd; font-weight:500;">Ïñ¥ÎîîÎ°ú Í∞àÍπåÏöî?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="Ï∂úÎ∞úÏßÄ (Ïòà: ÏÑúÏö∏Ïó≠)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ÎèÑÏ∞©ÏßÄ (Ïòà: Í∞ïÎÇ®Ïó≠)">
                </div>
                <div style="display:flex; gap:8px; margin:12px 0;">
                    <button class="pill" onclick="fillSearch('ÌòÑÏúÑÏπò', 'Ïßë')">üè† ÏßëÏúºÎ°ú</button>
                    <button class="pill" onclick="fillSearch('ÏÑúÏö∏Ïó≠', 'ÌôçÎåÄÏûÖÍµ¨')">üöá ÏòàÏãú Í≤ÄÏÉâ</button>
                </div>
                <button class="btn-search" onclick="runHybridSearch()">ÎåÄÏ§ëÍµêÌÜµ Í≤ΩÎ°ú Í≤ÄÏÉâ</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="totalTime">00Î∂Ñ</div>
                    <button class="pill" onclick="resetSearch()">Îã§Ïãú Í≤ÄÏÉâ</button>
                </div>
                <div class="sub-info" id="routeSummary">Í≤ΩÎ°ú Í≥ÑÏÇ∞ Ï§ë...</div>

                <div class="timeline" id="routeTimeline"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* -------------------------------------------
       [1] Ï¥àÍ∏∞Ìôî
       ------------------------------------------- */
    const mapContainer = document.getElementById('map');
    const mapOption = { 
        center: new kakao.maps.LatLng(37.566826, 126.9786567), 
        level: 6 
    };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places(); 
    
    // TMAP API ÌÇ§Îäî ÏÑúÎ≤Ñ(Vercel)Ïóê Ïà®Í≤®Ï†∏ ÏûàÏäµÎãàÎã§.

    let polylines = [];
    let markers = [];
    let isTrafficOn = false;

    window.onload = () => {
        map.relayout();
        moveToCurrentLocation();
    };

    /* -------------------------------------------
       [2] UI Î°úÏßÅ
       ------------------------------------------- */
    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
                const overlay = new kakao.maps.CustomOverlay({ map: map, position: loc, content: content });
                markers.push(overlay);
                map.panTo(loc);
            });
        }
    }

    function toggleTraffic() {
        if (isTrafficOn) { map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = false; }
        else { map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = true; }
    }

    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');
    const searchBar = document.querySelector('.search-bar');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet(); else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed'); sheet.classList.add('expanded');
        searchBar.style.display = 'none'; 
        if(!resultCard.classList.contains('active')) searchForm.style.display = 'block';
    }
    function collapseSheet() {
        sheet.classList.remove('expanded'); sheet.classList.add('collapsed');
        searchBar.style.display = 'flex'; 
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        clearMapData();
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
        map.setLevel(6); 
    }

    function clearMapData() {
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
    }

    /* -------------------------------------------
       [3] ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ (ÎÇ¥ ÏÑúÎ≤Ñ ÏÇ¨Ïö©!)
       ------------------------------------------- */
    async function runHybridSearch() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('Ï∂úÎ∞ú/ÎèÑÏ∞©ÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');

        const sCoord = await getKakaoCoords(sVal);
        const eCoord = await getKakaoCoords(eVal);
        
        if(!sCoord || !eCoord) return alert("Ïû•ÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");

        searchForm.style.display = 'none';
        resultCard.classList.add('active');
        
        await fetchTmapDataAndRender(sCoord, eCoord);
    }

    function getKakaoCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("ÌòÑÏúÑÏπò")) {
                navigator.geolocation.getCurrentPosition(pos => 
                    resolve({lng: pos.coords.longitude, lat: pos.coords.latitude, name: "ÎÇ¥ ÏúÑÏπò"}));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) 
                        resolve({lng: parseFloat(data[0].x), lat: parseFloat(data[0].y), name: data[0].place_name});
                    else resolve(null);
                });
            }
        });
    }

    async function fetchTmapDataAndRender(start, end) {
        // Í≥∞ÎèåÏù¥ÎãòÏùò Vercel ÏÑúÎ≤Ñ Ï£ºÏÜåÎ°ú Ïó∞Í≤∞ (ÏûêÎèô Î≥ÄÍ≤Ω ÏôÑÎ£å)
        const myServerUrl = "https://assist-jxup4d30i-notiks-projects.vercel.app"; 
        
        // Ïù¥Ï†ú API ÌÇ§Îäî ÌïÑÏöî ÏóÜÍ≥†, Ï¢åÌëúÎßå ÏÑúÎ≤ÑÎ°ú Î≥¥ÎÉÖÎãàÎã§.
        const payload = {
            startX: start.lng, startY: start.lat,
            endX: end.lng, endY: end.lat
        };

        try {
            document.getElementById('routeSummary').innerText = "ÏÑúÎ≤Ñ Í≤ΩÎ°ú ÏàòÏã† Ï§ë...";

            const response = await fetch(myServerUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // Vercel ÏÑúÎ≤Ñ ÏΩîÎìú(`proxy.js`)Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÍ±∞ÎÇò, Î∞∞Ìè¨Í∞Ä Ïïà ÎêêÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
                throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò (${response.status}): Vercel Î∞∞Ìè¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
            }

            const data = await response.json();
            
            if (!data.metaData || !data.metaData.plan) {
                alert("ÎåÄÏ§ëÍµêÌÜµ Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                document.getElementById('routeSummary').innerText = "Í≤ΩÎ°ú ÏóÜÏùå";
                return;
            }

            const itinerary = data.metaData.plan.itineraries[0];
            const totalTime = Math.round(itinerary.totalTime / 60);
            const totalFare = itinerary.fare.regular.totalFare;
            
            document.getElementById('totalTime').innerText = `${totalTime}Î∂Ñ`;
            document.getElementById('routeSummary').innerText = `ÏöîÍ∏à ${totalFare}Ïõê ‚Ä¢ ÌôòÏäπ ${itinerary.transferCount}Ìöå`;

            clearMapData();

            addMarker(start.lat, start.lng, 'start');
            addMarker(end.lat, end.lng, 'end');

            const timelineBox = document.getElementById('routeTimeline');
            timelineBox.innerHTML = '';
            addTimelineItem(timelineBox, 'walk', 'Ï∂úÎ∞ú', start.name);

            const legs = itinerary.legs;
            const bounds = new kakao.maps.LatLngBounds(); 
            let hasValidPath = false;

            legs.forEach(leg => {
                if (leg.passShape) {
                    const path = parseTmapShapeToKakao(leg.passShape);
                    if (path.length > 0) {
                        hasValidPath = true;
                        const color = leg.mode === 'WALK' ? '#8B95A1' : '#3182F6';
                        const style = leg.mode === 'WALK' ? 'shortdash' : 'solid';
                        const weight = leg.mode === 'WALK' ? 5 : 7; 

                        const polyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: weight, strokeColor: color,
                            strokeOpacity: 0.9, strokeStyle: style
                        });
                        polyline.setMap(map);
                        polylines.push(polyline);
                        path.forEach(point => bounds.extend(point));
                    }
                }

                if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'bus', `${leg.route} ÏäπÏ∞®`, `${time}Î∂Ñ Ïù¥Îèô`);
                } else if (leg.mode === 'WALK' && leg.sectionTime > 120) {
                    const time = Math.round(leg.sectionTime / 60);
                    addTimelineItem(timelineBox, 'walk', `ÎèÑÎ≥¥ Ïù¥Îèô`, `${time}Î∂Ñ`);
                }
            });

            addTimelineItem(timelineBox, 'walk', 'ÎèÑÏ∞©', end.name);
            
            map.relayout();
            if (hasValidPath && !bounds.isEmpty()) {
                setTimeout(() => map.setBounds(bounds, 50), 100); 
            } else {
                map.setCenter(new kakao.maps.LatLng(start.lat, start.lng));
            }

        } catch (e) {
            console.error(e);
            alert(`Ïò§Î•ò Î∞úÏÉù: ${e.message}`);
            document.getElementById('routeSummary').innerText = "Ïó∞Í≤∞ Ïã§Ìå®";
        }
    }

    function parseTmapShapeToKakao(passShape) {
        if (!passShape || typeof passShape !== 'string') return [];
        const coords = passShape.split(' ');
        return coords.map(c => {
            const [lng, lat] = c.split(',');
            return new kakao.maps.LatLng(parseFloat(lat), parseFloat(lng));
        });
    }

    function addMarker(lat, lng, type) {
        const content = `<div style="width:14px; height:14px; background:${type==='start'?'#191F28':'#FF3B30'}; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
        const marker = new kakao.maps.CustomOverlay({
            position: new kakao.maps.LatLng(lat, lng),
            map: map,
            content: content
        });
        markers.push(marker);
    }

    function addTimelineItem(container, type, title, desc = "") {
        let dotClass = 't-dot walk';
        let colorStyle = '';
        if(type === 'bus') { dotClass = 't-dot bus'; colorStyle = 'color:#3182F6;'; }
        
        const html = `
            <div class="t-item">
                <div class="${dotClass}"></div>
                <div class="t-text" style="${colorStyle}">${title}</div>
                ${desc ? `<div class="t-sub">${desc}</div>` : ''}
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
</script>

</body>
</html>
