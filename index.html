<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Real Navigation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-frame">
    <div id="map"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()" title="êµí†µìƒí™©">ğŸš¦</button>
        <button class="menu-item" onclick="moveToCurrentLocation()" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size: 18px;">ğŸ”</span>
                <span class="placeholder">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (í˜„ìœ„ì¹˜)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ ê²€ìƒ‰">
                </div>
                <div style="display:flex; gap:8px; margin:10px 0; overflow-x:auto;">
                    <button class="pill-btn" onclick="fillSearch('í˜„ìœ„ì¹˜', 'ì§‘')">ğŸ  ì§‘ìœ¼ë¡œ</button>
                    <button class="pill-btn" onclick="fillSearch('í˜„ìœ„ì¹˜', 'íšŒì‚¬')">ğŸ¢ íšŒì‚¬ë¡œ</button>
                </div>
                <button class="btn-search" onclick="findRealRoute()">ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="timeInfo">ê³„ì‚° ì¤‘...</div>
                    <button class="pill-btn" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info" id="distInfo">ê²½ë¡œë¥¼ íƒìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>

                <div class="timeline">
                    <div class="t-item">
                        <div class="t-dot"></div>
                        <div class="t-text" id="resStart">ì¶œë°œì§€</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot" style="background:#eee; border:none; width:6px; height:6px; left:-17px;"></div>
                        <div class="t-text" style="color:#3182F6;">ìë™ì°¨/íƒì‹œ ì´ë™</div>
                        <div class="t-desc">ì‹¤ì œ ë„ë¡œ ê²½ë¡œ (Kakao Mobility)</div>
                    </div>
                    <div class="t-item">
                        <div class="t-dot end"></div>
                        <div class="t-text" id="resEnd">ë„ì°©ì§€</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
    /* -------------------------------------------
       [1] ì„¤ì • ë° ì´ˆê¸°í™”
       ------------------------------------------- */
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(37.566826, 126.9786567), level: 7 };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const ps = new kakao.maps.services.Places();
    
    // ê°ì²´ ê´€ë¦¬
    let markers = [];
    let polylines = [];
    let isTrafficOn = false;

    // â˜…â˜…â˜… [í•„ìˆ˜] ì¹´ì¹´ì˜¤ REST API í‚¤ (JavaScript í‚¤ ì•„ë‹˜!) â˜…â˜…â˜…
    // ì—¬ê¸°ì— ë³¸ì¸ì˜ [REST API í‚¤]ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
    const REST_API_KEY = '321cd592b1f0ffce312bb7de8fb5db11'; 

    window.onload = () => moveToCurrentLocation();

    /* -------------------------------------------
       [2] UI ë° ê¸°ëŠ¥ (í† ê¸€, ìœ„ì¹˜)
       ------------------------------------------- */
    function toggleMenu() {
        document.getElementById('floatingMenu').classList.toggle('open');
    }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 4px 10px rgba(0,0,0,0.3);"></div>`;
                new kakao.maps.CustomOverlay({ map: map, position: loc, content: content });
                map.panTo(loc);
            });
        }
    }

    function toggleTraffic() {
        if (isTrafficOn) {
            map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            isTrafficOn = false;
        } else {
            map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
            isTrafficOn = true;
        }
    }

    /* -------------------------------------------
       [3] ì‹œíŠ¸ ë¡œì§
       ------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    /* -------------------------------------------
       [4] í•µì‹¬: ì¹´ì¹´ì˜¤ ëª¨ë¹Œë¦¬í‹° ê¸¸ì°¾ê¸° (Real Route)
       ------------------------------------------- */
    async function findRealRoute() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œ/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // 1. ì¥ì†Œ ê²€ìƒ‰í•˜ì—¬ ì¢Œí‘œ ì–»ê¸°
        const sCoord = await getCoords(sVal);
        const eCoord = await getCoords(eVal);
        
        if(!sCoord || !eCoord) return alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // 2. ê¸¸ì°¾ê¸° API í˜¸ì¶œ ë° ì„  ê·¸ë¦¬ê¸°
        await getCarDirection(sCoord, eCoord);

        // 3. ê²°ê³¼ì°½ ì—…ë°ì´íŠ¸
        searchForm.style.display = 'none';
        resultCard.classList.add('active');
        document.getElementById('resStart').innerText = sVal;
        document.getElementById('resEnd').innerText = eVal;
    }

    // ì¢Œí‘œ ê²€ìƒ‰ í•¨ìˆ˜
    function getCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("í˜„ìœ„ì¹˜")) {
                navigator.geolocation.getCurrentPosition(pos => resolve({lng: pos.coords.longitude, lat: pos.coords.latitude}));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) resolve({lng: parseFloat(data[0].x), lat: parseFloat(data[0].y)});
                    else resolve(null);
                });
            }
        });
    }

    // â˜… ì¹´ì¹´ì˜¤ ëª¨ë¹Œë¦¬í‹° API í˜¸ì¶œ í•¨ìˆ˜ (í•µì‹¬) â˜…
    async function getCarDirection(start, end) {
        const url = 'https://apis-navi.kakaomobility.com/v1/directions';
        
        // íŒŒë¼ë¯¸í„°: origin, destination (lng,lat ìˆœì„œ)
        const origin = `${start.lng},${start.lat}`;
        const destination = `${end.lng},${end.lat}`;
        
        const queryParams = new URLSearchParams({
            origin: origin,
            destination: destination,
            priority: 'RECOMMEND' // ì¶”ì²œ ê²½ë¡œ
        });

        const requestUrl = `${url}?${queryParams}`;

        try {
            const response = await fetch(requestUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `KakaoAK ${REST_API_KEY}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
            }

            const data = await response.json();
            
            // ê¸°ì¡´ ë§µ ì´ˆê¸°í™”
            polylines.forEach(p => p.setMap(null)); polylines = [];
            markers.forEach(m => m.setMap(null)); markers = [];

            // ë§ˆì»¤ ì°ê¸°
            new kakao.maps.Marker({map: map, position: new kakao.maps.LatLng(start.lat, start.lng)});
            new kakao.maps.Marker({map: map, position: new kakao.maps.LatLng(end.lat, end.lng)});

            // â˜… ê²½ë¡œ ë°ì´í„° íŒŒì‹± (Vertex ì²˜ë¦¬) â˜…
            const linePath = [];
            const routes = data.routes[0];
            const section = routes.sections[0];
            
            // ë„ë¡œ ì •ë³´(roads) ì•ˆì— ìˆëŠ” vertexes ë°°ì—´ì„ í’€ì–´ì„œ ê²½ë¡œ ë§Œë“¦
            section.roads.forEach(router => {
                router.vertexes.forEach((vertex, index) => {
                    // vertexesëŠ” [lng, lat, lng, lat...] ìˆœì„œë¡œ ì˜´
                    if (index % 2 === 0) {
                        linePath.push(new kakao.maps.LatLng(router.vertexes[index + 1], router.vertexes[index]));
                    }
                });
            });

            // ì§€ë„ì— ì„  ê·¸ë¦¬ê¸°
            const polyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 6,
                strokeColor: '#3182F6', // í† ìŠ¤ ë¸”ë£¨
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });
            polyline.setMap(map);
            polylines.push(polyline);

            // ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
            const bounds = new kakao.maps.LatLngBounds();
            linePath.forEach(latlng => bounds.extend(latlng));
            map.setBounds(bounds);

            // ì‹œê°„ ë° ê±°ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸
            const duration = routes.summary.duration; // ì´ˆ ë‹¨ìœ„
            const distance = routes.summary.distance; // ë¯¸í„° ë‹¨ìœ„
            
            const min = Math.round(duration / 60);
            const km = (distance / 1000).toFixed(1);

            document.getElementById('timeInfo').innerText = `${min}ë¶„`;
            document.getElementById('distInfo').innerText = `ì´ ê±°ë¦¬ ${km}km â€¢ íƒì‹œë¹„ ì•½ ${routes.summary.fare.taxi}ì›`;

        } catch (error) {
            console.error(error);
            alert('ê²½ë¡œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (CORS í™•ì¥í”„ë¡œê·¸ë¨ í™•ì¸ í•„ìš”)');
        }
    }
</script>

</body>
</html>
