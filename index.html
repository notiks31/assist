<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Real Transit Map</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-frame">
    <div id="map"></div>

    <div class="floating-menu" id="floatingMenu">
        <button class="menu-item" onclick="toggleTraffic()" title="êµí†µìƒí™©">ğŸš¦</button>
        <button class="menu-item" onclick="moveToCurrentLocation()" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
        <button class="toggle-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
        </button>
    </div>

    <div class="bottom-sheet collapsed" id="bottomSheet">
        <div class="sheet-header" onclick="toggleSheet()">
            <div class="handle-bar"></div>
        </div>

        <div class="sheet-content">
            <div class="search-bar" onclick="expandSheet()">
                <span style="font-size: 18px;">ğŸ”</span>
                <span class="placeholder">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</span>
            </div>

            <div class="search-form">
                <div class="input-row">
                    <div class="dot start"></div>
                    <input type="text" id="startInput" class="input-text" placeholder="ì¶œë°œì§€ (í˜„ìœ„ì¹˜)">
                </div>
                <div class="input-row">
                    <div class="dot end"></div>
                    <input type="text" id="endInput" class="input-text" placeholder="ë„ì°©ì§€ ê²€ìƒ‰">
                </div>
                <div style="display:flex; gap:8px; margin:10px 0; overflow-x:auto;">
                    <button class="pill-btn" onclick="fillSearch('í˜„ìœ„ì¹˜', 'ì§‘')">ğŸ  ì§‘ìœ¼ë¡œ</button>
                    <button class="pill-btn" onclick="fillSearch('í˜„ìœ„ì¹˜', 'íšŒì‚¬')">ğŸ¢ íšŒì‚¬ë¡œ</button>
                </div>
                <button class="btn-search" onclick="findTRoute()">ëŒ€ì¤‘êµí†µ ê²½ë¡œ ê²€ìƒ‰</button>
            </div>

            <div id="resultCard" class="result-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="time-info" id="totalTime">00ë¶„</div>
                    <button class="pill-btn" onclick="resetSearch()">ë‹¤ì‹œ ê²€ìƒ‰</button>
                </div>
                <div class="sub-info" id="routeSummary">ìµœì  ê²½ë¡œë¥¼ ì°¾ëŠ” ì¤‘...</div>

                <div class="timeline" id="routeTimeline">
                    </div>
                
                <button class="btn-search" style="margin-top:16px; background:#191F28;" onclick="resetSearch()">ì•ˆë‚´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/s/sdk.js?appkey=9d433a391319ff5dd19c3ae6940148df&libraries=services"></script>

<script>
/* -------------------------------------------
       [1] ì´ˆê¸°í™” ë° ë³€ìˆ˜ ì„¤ì • (ìˆ˜ì •ë¨)
       ------------------------------------------- */
    // 1. HTMLì— ìˆëŠ” id="map"ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const mapContainer = document.getElementById('map'); 
    
    // 2. 'kakao.s'ëŠ” ì˜¤íƒ€ì…ë‹ˆë‹¤. 'kakao.maps'ê°€ ë§ìŠµë‹ˆë‹¤.
    const mapOption = { 
        center: new kakao.maps.LatLng(37.566826, 126.9786567), 
        level: 7 
    };

    // 3. ë³€ìˆ˜ ì´ë¦„(map)ì´ ë¹ ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤. (const = ... -> const map = ...)
    const map = new kakao.maps.Map(mapContainer, mapOption);
    
    // 4. ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ ìƒì„±
    const ps = new kakao.maps.services.Places();
    
    let markers = [];
    let polylines = [];
    let isTrafficOn = false;

    // â˜…â˜…â˜… [í•„ìˆ˜] TMAP App Key (SK Open API) â˜…â˜…â˜…
    // ì…ë ¥í•˜ì‹  í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
    const TMAP_APP_KEY = 'vLTl0sk5ou1ba0TVgrpFM3Es6MWimZqo1xSDt3ti';

    window.onload = () => moveToCurrentLocation();

    /* -------------------------------------------
       [2] UI ê¸°ëŠ¥ (í† ê¸€, ìœ„ì¹˜ ë“±)
       ------------------------------------------- */
    function toggleMenu() { document.getElementById('floatingMenu').classList.toggle('open'); }

    function moveToCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                const content = `<div style="width:20px; height:20px; background:#3182F6; border:3px solid white; border-radius:50%; box-shadow:0 4px 10px rgba(0,0,0,0.3);"></div>`;
                new kakao.maps.CustomOverlay({ map: map, position: loc, content: content });
                map.panTo(loc);
            });
        }
    }

    function toggleTraffic() {
        if (isTrafficOn) { map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = false; }
        else { map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC); isTrafficOn = true; }
    }

    /* -------------------------------------------
       [3] ì‹œíŠ¸ ë¡œì§
       ------------------------------------------- */
    const sheet = document.getElementById('bottomSheet');
    const resultCard = document.getElementById('resultCard');
    const searchForm = document.querySelector('.search-form');

    function toggleSheet() {
        if(sheet.classList.contains('collapsed')) expandSheet();
        else collapseSheet();
    }
    function expandSheet() {
        sheet.classList.remove('collapsed');
        sheet.classList.add('expanded');
    }
    function collapseSheet() {
        sheet.classList.remove('expanded');
        sheet.classList.add('collapsed');
        document.getElementById('startInput').blur();
    }
    function fillSearch(s, e) {
        document.getElementById('startInput').value = s;
        document.getElementById('endInput').value = e;
        expandSheet();
    }
    function resetSearch() {
        polylines.forEach(p => p.setMap(null)); polylines = [];
        markers.forEach(m => m.setMap(null)); markers = [];
        resultCard.classList.remove('active');
        searchForm.style.display = 'block';
        collapseSheet();
    }

    /* -------------------------------------------
       [4] í•µì‹¬: TMAP ëŒ€ì¤‘êµí†µ API ì—°ë™
       ------------------------------------------- */
    async function findTmapRoute() {
        const sVal = document.getElementById('startInput').value;
        const eVal = document.getElementById('endInput').value;
        if(!sVal || !eVal) return alert('ì¶œë°œ/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // 1. ì¹´ì¹´ì˜¤ APIë¡œ ì¥ì†Œ ì¢Œí‘œ ê²€ìƒ‰
        const sCoord = await getCoords(sVal);
        const eCoord = await getCoords(eVal);
        
        if(!sCoord || !eCoord) return alert("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // 2. TMAP API í˜¸ì¶œ
        await callTmapTransit(sCoord, eCoord);

        // 3. UI ì—…ë°ì´íŠ¸
        searchForm.style.display = 'none';
        resultCard.classList.add('active');
    }

    function getCoords(keyword) {
        return new Promise(resolve => {
            if(keyword.includes("í˜„ìœ„ì¹˜")) {
                navigator.geolocation.getCurrentPosition(pos => resolve({lng: pos.coords.longitude, lat: pos.coords.latitude, name: "í˜„ìœ„ì¹˜"}));
            } else {
                ps.keywordSearch(keyword, (data, status) => {
                    if(status === kakao.maps.services.Status.OK) resolve({lng: data[0].x, lat: data[0].y, name: data[0].place_name});
                    else resolve(null);
                });
            }
        });
    }

    // â˜… TMAP ëŒ€ì¤‘êµí†µ API í˜¸ì¶œ í•¨ìˆ˜ â˜…
    async function callTmapTransit(start, end) {
        // TMAP ëŒ€ì¤‘êµí†µ ê²½ë¡œíƒìƒ‰ API URL
        const url = "https://apis.openapi.sk.com/transit/routes";
        
        const payload = {
            startX: start.lng,
            startY: start.lat,
            endX: end.lng,
            endY: end.lat,
            count: 1, // ê²½ë¡œ 1ê°œë§Œ ìš”ì²­
            lang: 0,
            format: "json"
        };

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "appKey": TMAP_APP_KEY,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("TMAP API Error");
            const data = await response.json();
            
            // ë°ì´í„° íŒŒì‹±
            const itinerary = data.metaData.plan.itineraries[0]; // ì²« ë²ˆì§¸ ì¶”ì²œ ê²½ë¡œ
            const totalTime = Math.round(itinerary.totalTime / 60); // ë¶„ ë‹¨ìœ„
            const totalFare = itinerary.fare.regular.totalFare;
            const transferCnt = itinerary.transferCount;

            // ìƒë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('totalTime').innerText = `${totalTime}ë¶„`;
            document.getElementById('routeSummary').innerText = `ìš”ê¸ˆ ${totalFare}ì› â€¢ í™˜ìŠ¹ ${transferCnt}íšŒ`;

            // ë§µ ì´ˆê¸°í™”
            polylines.forEach(p => p.setMap(null)); polylines = [];
            markers.forEach(m => m.setMap(null)); markers = [];

            // ë§ˆì»¤ ìƒì„±
            createMarker(start.lat, start.lng, 'start');
            createMarker(end.lat, end.lng, 'end');

            // íƒ€ì„ë¼ì¸ HTML ìƒì„± ì¤€ë¹„
            const timelineBox = document.getElementById('routeTimeline');
            timelineBox.innerHTML = ''; // ì´ˆê¸°í™”
            
            // ì¶œë°œì  íƒ€ì„ë¼ì¸
            addTimelineItem('ì¶œë°œ', start.name, 'start');

            // ê²½ë¡œ ê·¸ë¦¬ê¸° ë° íƒ€ì„ë¼ì¸ ì¶”ê°€
            const legs = itinerary.legs;
            const bounds = new kakao.maps.LatLngBounds();

            legs.forEach(leg => {
                // ì„  ê·¸ë¦¬ê¸° (LineString)
                if (leg.passShape) {
                    const path = parsePassShape(leg.passShape);
                    const color = leg.mode === 'WALK' ? '#8B95A1' : '#3182F6'; // ë„ë³´:íšŒìƒ‰, ë²„ìŠ¤:íŒŒë‘
                    const style = leg.mode === 'WALK' ? 'shortdash' : 'solid';
                    
                    const polyline = new kakao.maps.Polyline({
                        path: path,
                        strokeWeight: 6,
                        strokeColor: color,
                        strokeOpacity: 0.8,
                        strokeStyle: style
                    });
                    polyline.setMap(map);
                    polylines.push(polyline);
                    
                    path.forEach(p => bounds.extend(p));
                }

                // íƒ€ì„ë¼ì¸ ì•„ì´í…œ ì¶”ê°€
                if (leg.mode === 'BUS' || leg.mode === 'SUBWAY') {
                    const routeName = leg.route; // ë²„ìŠ¤ ë²ˆí˜¸ or ì§€í•˜ì²  í˜¸ì„ 
                    const sectionTime = Math.round(leg.sectionTime / 60);
                    addTimelineItem('bus', `${routeName} ìŠ¹ì°¨`, `${sectionTime}ë¶„ ì´ë™`);
                } else if (leg.mode === 'WALK' && leg.sectionTime > 120) { // 2ë¶„ ì´ìƒ ê±·ëŠ” ê²½ìš°ë§Œ í‘œì‹œ
                    const sectionTime = Math.round(leg.sectionTime / 60);
                    addTimelineItem('walk', `ë„ë³´ ì´ë™`, `${sectionTime}ë¶„`);
                }
            });

            // ë„ì°©ì  íƒ€ì„ë¼ì¸
            addTimelineItem('ë„ì°©', end.name, 'end');

            map.setBounds(bounds);

        } catch (e) {
            console.error(e);
            alert("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (TMAP í‚¤ í™•ì¸ í•„ìš”)");
        }
    }

    // TMAP ì¢Œí‘œ ë¬¸ìì—´ íŒŒì‹± (lon,lat lon,lat ...)
    function parsePassShape(passShape) {
        const path = [];
        const coords = passShape.split(' ');
        coords.forEach(c => {
            const [lng, lat] = c.split(',');
            path.push(new kakao.maps.LatLng(lat, lng));
        });
        return path;
    }

    function createMarker(lat, lng, type) {
        const color = type === 'start' ? '#191F28' : '#3182F6';
        const content = `<div style="width:14px; height:14px; background:${color}; border:3px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`;
        const overlay = new kakao.maps.CustomOverlay({ map: map, position: new kakao.maps.LatLng(lat, lng), content: content });
        markers.push(overlay);
    }

    function addTimelineItem(type, title, desc) {
        const box = document.getElementById('routeTimeline');
        let dotClass = '';
        let colorStyle = '';

        if(type === 'start') dotClass = 't-dot';
        else if(type === 'end') dotClass = 't-dot end';
        else if(type === 'bus') {
            dotClass = 't-dot';
            colorStyle = 'color:#3182F6;'; // íŒŒë€ ê¸€ì”¨
        } else {
            dotClass = 't-dot'; // ë„ë³´
        }

        const html = `
            <div class="t-item">
                <div class="${dotClass}" ${type==='bus' ? 'style="background:#f2f4f6; border:none; width:6px; height:6px; left:-17px;"' : ''}></div>
                <div class="t-text" style="${colorStyle}">${title}</div>
                ${desc ? `<div class="t-desc">${desc}</div>` : ''}
            </div>
        `;
        box.innerHTML += html;
    }
</script>

</body>
</html>
